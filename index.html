<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Softcity</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://ad.gigapub.tech/script?id=1327"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --gradient-start: #7f52ff; --gradient-end: #d152ff;
            --light-bg: #f3f4f6; --light-card-bg: #ffffff; --light-text: #111827;
            --light-secondary-text: #6b7280; --light-border: #e5e7eb;
            --dark-bg: #1f2937; --dark-card-bg: #374151; --dark-text: #f9fafb;
            --dark-secondary-text: #9ca3af; --dark-border: #4b5563;
            --accent-color: #5856d6; --accent-hover: #4c4ac6; --gold: #ffc700;
            --silver: #c0c0c0; --bronze: #cd7f32;
            --status-pending-bg: #fef3c7; --status-pending-text: #92400e;
            --status-completed-bg: #d1fae5; --status-completed-text: #065f46;
            --status-rejected-bg: #fee2e2; --status-rejected-text: #991b1b;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0 0 100px 0; transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; }
        body.light { --bg-color: var(--light-bg); --card-bg-color: var(--light-card-bg); --text-color: var(--light-text); --secondary-text-color: var(--light-secondary-text); --border-color: var(--light-border); }
        body.dark { --bg-color: var(--dark-bg); --card-bg-color: var(--dark-card-bg); --text-color: var(--dark-text); --secondary-text-color: var(--dark-secondary-text); --border-color: var(--dark-border); }
        body { background-color: var(--bg-color); color: var(--text-color); }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 0 15px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .header-bg { background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); height: 120px; border-radius: 0 0 30px 30px; margin: 0 -15px 0 -15px; position: absolute; top: 0; left: 0; right: 0; z-index: -1; }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; color: white; }
        .top-header .title { font-size: 20px; font-weight: 600; }
        #theme-toggle { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .profile-card { background: var(--card-bg-color); border-radius: 20px; padding: 20px; text-align: center; margin-top: 50px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; background-color: var(--light-bg); margin: -60px auto 10px; border: 4px solid var(--card-bg-color); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        .profile-pic .initial { font-size: 32px; font-weight: bold; color: var(--accent-color); }
        .card { background: var(--card-bg-color); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .action-button { width: 100%; padding: 12px; background-color: var(--accent-color); border: 1px solid var(--accent-color); color: white; border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-button:disabled { background-color: #ccc; border-color: #ccc; color: #666; cursor: not-allowed; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-top: 1px solid var(--border-color); z-index: 100; flex-wrap: wrap; }
        .nav-item { cursor: pointer; text-align: center; color: var(--secondary-text-color); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.2s; padding: 0 5px; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item svg { width: 24px; height: 24px; }
        .leaderboard-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: var(--card-bg-color); border-radius: 12px; margin-bottom: 10px; border: 2px solid transparent; }
        .leaderboard-item.rank-1 { border-color: var(--gold); }
        .leaderboard-item.rank-2 { border-color: var(--silver); }
        .leaderboard-item.rank-3 { border-color: var(--bronze); }
        .leaderboard-item .rank { font-size: 18px; font-weight: 700; color: var(--secondary-text-color); width: 30px; text-align: center; }
        .leaderboard-item .pic { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; background-color: var(--light-bg); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; color: var(--accent-color); }
        .leaderboard-item .info { flex-grow: 1; cursor: pointer; text-align: left; }
    </style>
</head>
<body class="light">
    
    <div id="loading-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-color); z-index:200; display:flex; align-items:center; justify-content:center;">
        <p>Loading App...</p>
    </div>

    <div class="header-bg"></div>
    <div class="top-header container">
        <h1 class="title">Softcity</h1>
        <button id="theme-toggle">🌙</button>
    </div>

    <div class="container">
        <div id="views-container">
            <div id="home-view" class="view"></div>
            <div id="tasks-view" class="view hidden"></div>
            <div id="shop-view" class="view hidden"></div>
            <div id="bonus-view" class="view hidden"></div>
            <div id="withdraw-view" class="view hidden"></div>
            <div id="history-view" class="view hidden"></div>
            <div id="referral-view" class="view hidden"></div>
            <div id="leaderboard-page-view" class="view hidden"></div>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <div class="nav-item active" data-view="home-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</div>
        <div class="nav-item" data-view="tasks-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2m0 14H4V6h16zM6 10h4v4H6zm6 0h6v4h-6z"/></svg>Tasks</div>
        <div class="nav-item" data-view="shop-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 18c-1.11 0-2 .89-2 2s.89 2 2 2 2-.89 2-2-.89-2-2-2zm-12 0c-1.11 0-2 .89-2 2s.89 2 2 2 2-.89 2-2-.89-2-2-2zm1 0h10V4H6v14zM5.21 2.77L4.27 2H2v2h2.21l3.58 7.59-1.35 2.44A2 2 0 0 0 8 16h9v-2H8.53l1.1-2H15.7l3.58-6.41L18.63 4H19V2h-3.45z"/></svg>Shop</div>
        <div class="nav-item" data-view="bonus-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .35.07.69.18 1H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2m-8-1a1 1 0 0 1 1-1 1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1M12 19a3 3 0 0 1-3-3h6a3 3 0 0 1-3 3z"/></svg>Bonus</div>
        <div class="nav-item" data-view="withdraw-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2m14 14V8H5v10zm-7-7a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3z"/></svg>Withdraw</div>
        <div class="nav-item" data-view="history-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9m-1 5v5l4.25 2.52.75-1.23-3.5-2.08V8z"/></svg>History</div>
        <div class="nav-item" data-view="referral-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 11a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3m-8 0a5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5m0 8c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m11.5-3.5a2.5 2.5 0 0 0-2.5-2.5 2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5m-2.5 4c-1.95 0-5.8 1-5.8 3v1.5h11.6V20c0-2-3.85-3-5.8-3z"/></svg>Referral</div>
    </nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Firebase and Telegram Setup ---
    const firebaseConfig = { apiKey: "AIzaSyDVNsMeB1jzOcIqAJjryUYmipT_SKrJi9k", authDomain: "giveawaybd.firebaseapp.com", databaseURL: "https://giveawaybd-default-rtdb.firebaseio.com", projectId: "giveawaybd" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;

    // --- Global State ---
    let currentUser = {}; 
    let appSettings = {};
    const userId = tg.initDataUnsafe?.user?.id.toString() || 'test_user_12345';
    const userName = tg.initDataUnsafe?.user?.first_name || 'Test User';
    const userPhoto = tg.initDataUnsafe?.user?.photo_url;
    
    // --- App Initialization ---
    async function initializeApp() {
        try {
            tg.ready();
            tg.expand();

            const settingsSnapshot = await db.ref('settings').get();
            if (!settingsSnapshot.exists()) throw new Error("App settings not found.");
            appSettings = settingsSnapshot.val();
            
            tg.setHeaderColor(appSettings.themeColor || '#7f52ff');
            document.querySelector('.top-header .title').textContent = appSettings.appName || 'Softcity';

            const userRef = db.ref(`users/${userId}`);
            const userSnapshot = await userRef.get();
            
            if (userSnapshot.exists()) {
                currentUser = userSnapshot.val();
            } else {
                const referralCode = 'REF' + Math.random().toString(36).substring(2, 8).toUpperCase();
                currentUser = { id: userId, name: userName, points: 0, referralCode, photo_url: userPhoto || '', stats: { totalAds: 0, referrals: 0, adsToday: 0, lastAdDate: '' }, createdAt: new Date().toISOString() };
                await userRef.set(currentUser);
            }
            
            // Listen for realtime updates on user data
            userRef.on('value', (snapshot) => {
                currentUser = snapshot.val();
                if (document.querySelector('#home-view:not(.hidden)')) {
                    renderHomeView();
                }
            });
            
            // Render initial view
            renderHomeView();
            document.getElementById('loading-overlay').style.display = 'none';

        } catch (error) {
            console.error("Initialization failed:", error);
            document.getElementById('loading-overlay').innerHTML = `<p>Error: ${error.message}</p>`;
        }
    }

    // --- Navigation ---
    function navigate(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.querySelectorAll('.nav-item').forEach(v => v.classList.remove('active'));
        
        document.querySelector(`.nav-item[data-view="${viewId}"]`).classList.add('active');
        const targetView = document.getElementById(viewId);
        targetView.classList.remove('hidden');

        // Render view content dynamically
        switch (viewId) {
            case 'home-view': renderHomeView(); break;
            case 'tasks-view': renderTasksView(); break;
            case 'shop-view': renderShopView(); break;
            case 'bonus-view': renderBonusView(); break;
            case 'withdraw-view': renderWithdrawView(); break;
            case 'history-view': renderHistoryView(); break;
            case 'referral-view': renderReferralView(); break;
            case 'leaderboard-page-view': renderLeaderboardView(); break;
        }
    }
    document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', () => navigate(item.dataset.view)));

    // --- View Renderers ---
    function renderHomeView() {
        const view = document.getElementById('home-view');
        const stats = currentUser.stats || {};
        const today = new Date().toISOString().slice(0, 10);
        const adsToday = (stats.lastAdDate === today) ? (stats.adsToday || 0) : 0;
        
        let picHtml = '';
        if (currentUser.photo_url) {
            picHtml = `<img src="${currentUser.photo_url}">`;
        } else {
            const initial = (currentUser.name || 'U').charAt(0).toUpperCase();
            picHtml = `<span class="initial">${initial}</span>`;
        }
        
        view.innerHTML = `
            <div class="profile-card">
                <div class="profile-pic">${picHtml}</div>
                <h2 style="font-size: 20px; font-weight: 600;">${currentUser.name || 'User'}</h2>
                <div style="background-color: var(--accent-color); color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 14px; margin-top: 5px;">${currentUser.points || 0} Points</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0;">
                    <div><div style="font-size: 18px; font-weight: 600;">${adsToday}</div><div style="font-size: 12px; color: var(--secondary-text-color);">Today's Ads</div></div>
                    <div><div style="font-size: 18px; font-weight: 600;">${stats.totalAds || 0}</div><div style="font-size: 12px; color: var(--secondary-text-color);">Total Ads</div></div>
                    <div><div style="font-size: 18px; font-weight: 600;">${stats.referrals || 0}</div><div style="font-size: 12px; color: var(--secondary-text-color);">Referrals</div></div>
                </div>
                <button class="action-button" onclick="navigate('leaderboard-page-view')" style="background: transparent; color: var(--accent-color);">🏆 View Leaderboard</button>
            </div>
            ${appSettings.notice ? `<div class="card" style="background-color: var(--accent-color); color: white;"><h3 class="card-title" style="color: white; border: none;">📢 Notice</h3><p style="font-size: 14px; margin: 0;">${appSettings.notice}</p></div>` : ''}
            <div class="card"><h3 class="card-title">Welcome, ${currentUser.name?.split(' ')[0] || 'User'}!</h3><p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">Complete tasks, invite friends, and earn points.</p><button class="action-button" onclick="tg.openLink('${appSettings.joinChannelUrl || ''}')">🚀 Join Channel</button></div>
        `;
    }

    function renderTasksView() {
        const view = document.getElementById('tasks-view');
        const stats = currentUser.stats || {};
        const today = new Date().toISOString().slice(0, 10);
        const adsWatchedToday = (stats.lastAdDate === today) ? (stats.adsToday || 0) : 0;
        const dailyLimit = appSettings.dailyAdLimit || 20;
        const adsLeft = dailyLimit - adsWatchedToday;

        view.innerHTML = `
            <div class="card"><h3 class="card-title">Promote Services</h3><p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">আপনার ব্যালেন্স দিয়ে আপনার চ্যানেল প্রোমোট করুন।</p><button class="action-button" onclick="navigate('shop-view')" style="margin-top: 15px;">🚀 Promote Now</button></div>
            <div class="card"><h3 class="card-title">Watch Ads & Earn</h3><p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">You have ${adsLeft > 0 ? adsLeft : 0} ads left for today.</p><button id="watch-ad-btn" class="action-button" ${adsLeft <= 0 ? 'disabled' : ''}><svg style="width:20px; height:20px;" viewBox="0 0 24 24" fill="currentColor"><path d="M22,10.45V13.55A1,1 0 0,1 21,14.55C20.84,14.55 20.68,14.5 20.53,14.43L18,13.35V16.5A1.5,1.5 0 0,1 16.5,18H3.5A1.5,1.5 0 0,1 2,16.5V7.5A1.5,1.5 0 0,1 3.5,6H16.5A1.5,1.5 0 0,1 18,7.5V10.65L20.53,9.57C20.83,9.44 21.17,9.5 21.39,9.73C21.5,9.84 21.56,10 21.56,10.15L22,10.45M10,10.5A1.5,1.5 0 0,0 8.5,12A1.5,1.5 0 0,0 10,13.5A1.5,1.5 0 0,0 11.5,12A1.5,1.5 0 0,0 10,10.5Z" /></svg><span>${adsLeft > 0 ? 'Watch Ad' : 'Limit Reached'}</span></button></div>`;
        
        view.querySelector('#watch-ad-btn').onclick = handleWatchAd;
    }

    async function renderShopView() {
        const view = document.getElementById('shop-view');
        view.innerHTML = `<div class="card"><h3 class="card-title">🛒 Shop</h3><div id="shop-items-container"><p>Loading shop items...</p></div></div>`;
        const container = view.querySelector('#shop-items-container');
        const shopSettings = appSettings.shop || {};
        const enabledItems = Object.entries(shopSettings).filter(([_, item]) => item.enabled);

        if (enabledItems.length === 0) {
            container.innerHTML = '<p>Shop is currently empty. Check back later!</p>';
            return;
        }
        container.innerHTML = '';
        enabledItems.forEach(([key, item]) => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'shop-item';
            itemDiv.innerHTML = `<h4>${item.title}</h4><p class="price-tag">Price: ${item.price} points per item</p>
                <div class="form-group"><label for="shop-${key}-link">${item.linkTitle}</label><input type="text" id="shop-${key}-link" placeholder="${item.placeholder}"></div>
                <div class="form-group"><label for="shop-${key}-quantity">Quantity</label><input type="number" id="shop-${key}-quantity" placeholder="e.g., 100"></div>
                <button class="action-button">Buy Now</button>`;
            itemDiv.querySelector('button').onclick = () => handlePurchase(key, item.price);
            container.appendChild(itemDiv);
        });
    }

    async function renderHistoryView() {
        const view = document.getElementById('history-view');
        view.innerHTML = `<div class="card"><h3 class="card-title">Transaction History</h3><div id="history-list"><p>Loading history...</p></div></div>`;
        const list = view.querySelector('#history-list');
        
        const [withdrawalsSnap, purchasesSnap] = await Promise.all([
            db.ref('withdrawals').orderByChild('userId').equalTo(userId).get(),
            db.ref('purchases').orderByChild('userId').equalTo(userId).get()
        ]);
        
        let allHistory = [];
        if (withdrawalsSnap.exists()) withdrawalsSnap.forEach(s => allHistory.push({ ...s.val(), type: `Withdraw`, time: s.val().requestedAt, amount: s.val().amount }));
        if (purchasesSnap.exists()) purchasesSnap.forEach(s => allHistory.push({ ...s.val(), type: `Purchase`, time: s.val().createdAt, amount: s.val().cost }));
        
        allHistory.sort((a, b) => b.time - a.time);

        if (allHistory.length === 0) {
            list.innerHTML = '<p>No transaction history found.</p>';
            return;
        }
        list.innerHTML = '';
        allHistory.forEach(item => {
            list.innerHTML += `<div class="history-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--border-color);"><div class="info"><div style="font-weight: 500;">${item.type} (${item.itemType || item.method})</div><div style="font-size: 12px; color: var(--secondary-text-color);">${new Date(item.time).toLocaleString()}</div></div><div class="status ${item.status}" style="font-weight: 600; padding: 3px 8px; border-radius: 8px; font-size: 12px; text-transform: capitalize;">${item.amount} pts - ${item.status}</div></div>`;
        });
    }

    function renderBonusView() {
        const view = document.getElementById('bonus-view');
        view.innerHTML = `
            <div class="card" style="padding: 20px; background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end)); border-radius: 15px; color: white;">
                <h3 class="card-title" style="color:white; border:none; text-align:center;">Daily Check-in Bonus</h3>
                <p style="font-size: 14px; margin-top: -10px; text-align:center;">Claim your daily reward and keep your streak!</p>
                <button class="action-button" style="background:white; color: var(--accent-color); margin-top: 20px;">Claim Reward</button>
            </div>`;
    }

    function renderReferralView() {
        const view = document.getElementById('referral-view');
        const referralLink = currentUser.referralCode ? `https://t.me/${appSettings.botUsername}?start=${currentUser.referralCode}` : '';
        view.innerHTML = `
            <div class="card">
                <div style="text-align:center;">
                    <h3 class="card-title" style="text-align:center; border:none; font-size: 24px; font-weight: 700;">Refer & Earn Forever</h3>
                    <p style="color: var(--secondary-text-color); margin-top: -10px;">Earn <strong style="color:var(--accent-color)">${appSettings.referralCommission || 10}%</strong> of your friends earnings for life!</p>
                </div>
                <ul style="list-style:none; padding:0; margin: 25px 0;">
                    <li style="display:flex; align-items:center; gap: 15px; margin-bottom: 20px;"><div style="width:40px;height:40px;border-radius:50%;background:var(--bg-color);display:flex;align-items:center;justify-content:center;color:var(--accent-color);">🔗</div><div><h4 style="margin:0;">1. Copy Your Link</h4><p style="font-size:12px; color:var(--secondary-text-color); margin:0;">Grab your unique referral link below.</p></div></li>
                    <li style="display:flex; align-items:center; gap: 15px; margin-bottom: 20px;"><div style="width:40px;height:40px;border-radius:50%;background:var(--bg-color);display:flex;align-items:center;justify-content:center;color:var(--accent-color);">🤝</div><div><h4 style="margin:0;">2. Share with Friends</h4><p style="font-size:12px; color:var(--secondary-text-color); margin:0;">Use the buttons to share your link.</p></div></li>
                    <li style="display:flex; align-items:center; gap: 15px;"><div style="width:40px;height:40px;border-radius:50%;background:var(--bg-color);display:flex;align-items:center;justify-content:center;color:var(--accent-color);">💰</div><div><h4 style="margin:0;">3. Earn Lifetime Rewards</h4><p style="font-size:12px; color:var(--secondary-text-color); margin:0;">Get rewards forever once they join!</p></div></li>
                </ul>
                <div style="text-align: center; margin-top: 20px;"><label for="referral-link-input">Your Referral Link</label><input type="text" id="referral-link-input" value="${referralLink}" readonly style="width:100%; padding:12px; box-sizing:border-box; text-align:center; border-style:dashed; background-color: var(--bg-color); border-radius: 10px; border-color: var(--border-color); color: var(--text-color);">
                <div style="display:flex; gap:10px; margin-top:15px;"><button id="share-tg" class="action-button" style="background-color:#2AABEE;flex-grow:1;">Telegram</button><button id="share-wa" class="action-button" style="background-color:#25D366;flex-grow:1;">WhatsApp</button></div></div>
            </div>`;
        view.querySelector('#share-tg').onclick = () => shareLink('tg', referralLink);
        view.querySelector('#share-wa').onclick = () => shareLink('wa', referralLink);
    }
    
    // --- Action Handlers ---
    window.handlePurchase = async (key, price) => {
        const link = document.getElementById(`shop-${key}-link`).value;
        const quantity = parseInt(document.getElementById(`shop-${key}-quantity`).value, 10);
        if (!link || !quantity || quantity <= 0) { tg.showAlert('Please provide a valid link and quantity.'); return; }
        const cost = quantity * price;
        if ((currentUser.points || 0) < cost) { tg.showAlert(`You need ${cost} points.`); return; }
        const purchaseData = { userId, userName, itemType: appSettings.shop[key].title, quantity, cost, link, status: 'pending', createdAt: firebase.database.ServerValue.TIMESTAMP };
        try {
            await db.ref('purchases').push(purchaseData);
            await db.ref(`users/${userId}/points`).set(firebase.database.ServerValue.increment(-cost));
            tg.showAlert('Purchase request sent!');
            navigate('shop-view'); // Refresh view
        } catch (e) { tg.showAlert('An error occurred.'); }
    };

    function handleWatchAd() {
        const watchAdBtn = document.getElementById('watch-ad-btn');
        if (watchAdBtn) {
            watchAdBtn.disabled = true;
            watchAdBtn.querySelector('span').textContent = 'Loading Ad...';
        }

        window.showGiga().then(() => {
            const today = new Date().toISOString().slice(0, 10);
            const adReward = appSettings.adReward || 10;
            const userStatsRef = db.ref(`users/${userId}/stats`);
            
            db.ref(`users/${userId}/points`).set(firebase.database.ServerValue.increment(adReward));
            userStatsRef.child('totalAds').set(firebase.database.ServerValue.increment(1));
            
            userStatsRef.transaction(stats => {
                stats = stats || { adsToday: 0, lastAdDate: '' };
                stats.adsToday = (stats.lastAdDate === today) ? (stats.adsToday || 0) + 1 : 1;
                stats.lastAdDate = today;
                return stats;
            }).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(`Congratulations! You've earned ${adReward} points.`);
                renderTasksView(); // Re-render to update button state
            });
        }).catch(e => {
            tg.showAlert('No ad available right now. Please try again later.');
            if(watchAdBtn) watchAdBtn.disabled = false;
        });
    }

    window.shareLink = (platform, link) => {
        if (!link) return;
        const text = `Join ${appSettings.appName || 'Softcity'} and earn rewards!`;
        if (platform === 'tg') tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
        if (platform === 'wa') window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text + ' ' + link)}`, '_blank');
    }

    initializeApp();
});
</script>
</body>
</html>
