<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Softcity</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://ad.gigapub.tech/script?id=1327"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --gradient-start: #7f52ff; --gradient-end: #d152ff;
            --light-bg: #f3f4f6; --light-card-bg: #ffffff; --light-text: #111827;
            --light-secondary-text: #6b7280; --light-border: #e5e7eb;
            --dark-bg: #1f2937; --dark-card-bg: #374151; --dark-text: #f9fafb;
            --dark-secondary-text: #9ca3af; --dark-border: #4b5563;
            --accent-color: #5856d6; --accent-hover: #4c4ac6; --gold: #ffc700;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0 0 100px 0; transition: background-color 0.3s, color 0.3s; }
        body.light { --bg-color: var(--light-bg); --card-bg-color: var(--light-card-bg); --text-color: var(--light-text); --secondary-text-color: var(--light-secondary-text); --border-color: var(--light-border); }
        body.dark { --bg-color: var(--dark-bg); --card-bg-color: var(--dark-card-bg); --text-color: var(--dark-text); --secondary-text-color: var(--dark-secondary-text); --border-color: var(--dark-border); }
        body { background-color: var(--bg-color); color: var(--text-color); }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 0 15px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; }
        .top-header .title { font-size: 20px; font-weight: 600; }
        #theme-toggle { background: var(--card-bg-color); border: 1px solid var(--border-color); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .header-bg { background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); height: 120px; border-radius: 0 0 30px 30px; margin: 0 -15px 0 -15px; position: absolute; top: 0; left: 0; right: 0; z-index: -1; }
        .profile-card { background: var(--card-bg-color); border-radius: 20px; padding: 20px; text-align: center; margin-top: 50px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: -60px auto 10px; border: 4px solid var(--card-bg-color); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .profile-pic img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        #user-name { font-size: 20px; font-weight: 600; }
        #user-points { background-color: var(--accent-color); color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 14px; margin-top: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .stat-item .value { font-size: 18px; font-weight: 600; }
        .stat-item .label { font-size: 12px; color: var(--secondary-text-color); }
        .action-button { width: 100%; padding: 12px; background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-button:hover { background-color: var(--accent-color); color: white; }
        .action-button:disabled { background-color: #ccc; border-color: #ccc; color: #666; cursor: not-allowed; }
        .card { background: var(--card-bg-color); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .notice-card { background-color: var(--accent-color); color: white; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; box-sizing: border-box; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-color); font-size: 14px; }
        .shop-item { border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .shop-item h4 { margin-top: 0; }
        .price-tag { font-size: 12px; color: var(--secondary-text-color); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-top: 1px solid var(--border-color); z-index: 100; flex-wrap: wrap; }
        .nav-item { cursor: pointer; text-align: center; color: var(--secondary-text-color); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.2s; padding: 0 5px; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item svg { width: 24px; height: 24px; }
        
        /* === ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶°‡¶æ‡¶∞‡¶¨‡ßã‡¶∞‡ßç‡¶°, ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø CSS === */
        .list-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-radius: 10px; transition: background-color 0.2s; }
        .list-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .list-item .rank { font-size: 18px; font-weight: 600; color: var(--secondary-text-color); width: 30px; text-align: center; }
        .list-item .p-pic { width: 45px; height: 45px; border-radius: 50%; background-color: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .list-item .p-pic img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .list-item .info { flex-grow: 1; }
        .list-item .info .name { font-weight: 600; }
        .list-item .info .details { font-size: 12px; color: var(--secondary-text-color); }
        .list-item.leaderboard-item { cursor: pointer; }
        .rank-badge { width: 24px; height: 24px; display: inline-block; background-size: contain; background-repeat: no-repeat; text-align: center; line-height: 24px; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .rank-1 { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="%23FFD700" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>'); }
        .referral-header { text-align: center; padding: 20px; background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end)); border-radius: 15px; color: white; }
        .referral-header .commission { position: absolute; top: 10px; right: 10px; background: white; color: var(--accent-color); padding: 5px 10px; border-radius: 20px; font-weight: bold; }
        .referral-steps { list-style: none; padding: 0; margin-top: 20px; }
        .referral-steps li { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .referral-steps .icon { background: var(--bg-color); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .referral-link-area { margin-top: 20px; }
        .referral-link-area input { text-align: center; }
        .share-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .status { padding: 3px 8px; border-radius: 10px; font-size: 12px; font-weight: 500; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-approved { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="light">
    
    <div class="header-bg"></div>
    <div class="top-header container">
        <h1 class="title">Softcity üí∏</h1>
        <button id="theme-toggle">üåô</button>
    </div>

    <div class="container">
        <!-- Views Wrapper -->
        <div id="views-container">
            <!-- Views (Home, Tasks, Shop) are the same as before -->
            <div id="home-view" class="view">
                 <div class="profile-card">
                    <div class="profile-pic"><img id="profile-img" src="" alt=""></div>
                    <h2 id="user-name">Loading...</h2>
                    <div id="user-points">0 Points</div>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="value" id="stats-today-ads">0</div><div class="label">Today's Ads</div></div>
                        <div class="stat-item"><div class="value" id="stats-total-ads">0</div><div class="label">Total Ads</div></div>
                        <div class="stat-item"><div class="value" id="stats-referrals">0</div><div class="label">Referrals</div></div>
                    </div>
                    <button class="action-button leaderboard-nav-btn">üèÜ Leaderboard</button>
                </div>
                <div id="notice-card" class="card notice-card hidden">
                    <h3 class="card-title" style="color: white;">üì¢ Notice</h3>
                    <p id="notice-text" style="font-size: 14px;"></p>
                 </div>
                <div class="card">
                    <h3 class="card-title">Welcome, <span id="welcome-name">User</span>!</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">Complete tasks, invite friends, and earn points.</p>
                    <button class="action-button" style="background-color: var(--accent-color); color: white;" id="join-channel-btn">üöÄ Join Channel</button>
                </div>
            </div>
            <div id="tasks-view" class="view hidden">
                <div class="card">
                    <h3 class="card-title">Promote Services</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡ßã‡¶Æ‡ßã‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <button class="action-button" id="go-to-shop-btn" style="margin-top: 15px;">üöÄ Promote Now</button>
                </div>
                <div class="card">
                    <h3 class="card-title">Watch Ads & Earn</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;" id="ads-left-text">Loading...</p>
                    <button class="action-button" style="background-color: var(--accent-color); color: white;" id="watch-ad-btn" disabled>
                        <svg style="width:20px; height:20px;" viewBox="0 0 24 24"><path fill="currentColor" d="M22,10.45V13.55A1,1 0 0,1 21,14.55C20.84,14.55 20.68,14.5 20.53,14.43L18,13.35V16.5A1.5,1.5 0 0,1 16.5,18H3.5A1.5,1.5 0 0,1 2,16.5V7.5A1.5,1.5 0 0,1 3.5,6H16.5A1.5,1.5 0 0,1 18,7.5V10.65L20.53,9.57C20.83,9.44 21.17,9.5 21.39,9.73C21.5,9.84 21.56,10 21.56,10.15L22,10.45M10,10.5A1.5,1.5 0 0,0 8.5,12A1.5,1.5 0 0,0 10,13.5A1.5,1.5 0 0,0 11.5,12A1.5,1.5 0 0,0 10,10.5Z" /></svg>
                        <span>Watch Ad</span>
                    </button>
                </div>
            </div>
            <div id="shop-view" class="view hidden">
                 <div class="card">
                    <h3 class="card-title">üõí Shop</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">Use your points to buy services.</p>
                    <div class="shop-item">
                        <h4>Buy Telegram Members</h4>
                        <p class="price-tag" id="shop-members-details">Loading...</p>
                        <div class="form-group"><label for="shop-member-link">Channel/Group Link</label><input type="text" id="shop-member-link" placeholder="e.g., https://t.me/yourchannel"></div>
                        <div class="form-group"><label for="shop-member-quantity">Quantity</label><input type="number" id="shop-member-quantity" placeholder="e.g., 100"></div>
                        <button class="action-button" onclick="handlePurchase('members')">Buy Members</button>
                    </div>
                </div>
            </div>

            <!-- Bonus, Withdraw, and other views will be added below -->
            <div id="bonus-view" class="view hidden">
                <div class="card bonus-container">
                    <h3 class="card-title" style="color:white; border:none; text-align:center;">Daily Check-in Bonus</h3>
                    <p style="font-size: 14px; margin-top: -10px; text-align:center;">Claim your daily reward and keep your streak!</p>
                    <div id="bonus-grid" class="bonus-grid"></div>
                    <div class="bonus-progress-bar"><div id="bonus-progress" class="bonus-progress"></div></div>
                    <button class="action-button" id="claim-bonus-btn" disabled>Claim Reward</button>
                </div>
            </div>
            <div id="withdraw-view" class="view hidden">
                <div class="card" id="withdraw-card">
                    <h3 class="card-title">Withdraw Points</h3>
                    <div class="form-group">
                        <label>Balance: <span id="withdraw-balance">0</span> points</label>
                        <label style="font-size:12px; color:var(--secondary-text-color)">Min: <span id="min-withdraw">...</span> / Max: <span id="max-withdraw">...</span></label>
                        <input type="number" id="withdraw-amount" placeholder="e.g., 20000">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-method">Method</label>
                        <select id="withdraw-method"></select>
                    </div>
                    <div class="form-group"><label for="withdraw-account">Account Details</label><input type="text" id="withdraw-account" placeholder="Your account number or ID"></div>
                    <button class="action-button" id="submit-withdraw-btn" style="background-color: var(--accent-color); color: white;">Submit Request</button>
                </div>
                <div class="card hidden" id="withdraw-disabled-card"><p>Withdrawal is temporarily disabled. Please check back later.</p></div>
            </div>
            
            <!-- === ‡¶®‡¶§‡ßÅ‡¶® History View === -->
            <div id="history-view" class="view hidden">
                <div class="card">
                    <h3 class="card-title">Transaction History</h3>
                    <div id="history-list"><p style="text-align:center; color:var(--secondary-text-color);">No history found.</p></div>
                </div>
            </div>
            
            <!-- === ‡¶®‡¶§‡ßÅ‡¶® Referral View === -->
            <div id="referral-view" class="view hidden">
                <div class="card referral-header">
                    <div id="referral-commission-badge" class="commission">...%</div>
                    <h2>Refer & Earn Forever</h2>
                    <p style="font-size: 14px; margin-top: -10px;">Earn a percentage of your friends' earnings for life!</p>
                </div>
                <div class="card">
                    <ul class="referral-steps">
                        <li><div class="icon">üîó</div><div><h4>1. Copy Your Link</h4><p>Grab your unique referral link below.</p></div></li>
                        <li><div class="icon">üì§</div><div><h4>2. Share with Friends</h4><p>Use the buttons to share your link.</p></div></li>
                        <li><div class="icon">üí∞</div><div><h4>3. Earn Lifetime Rewards</h4><p>Get rewards every time your friends earn.</p></div></li>
                    </ul>
                    <div class="referral-link-area">
                        <h4>Your Referral Link</h4>
                        <input type="text" id="referral-link" readonly>
                        <div class="share-buttons">
                            <button class="action-button" id="share-telegram">Telegram</button>
                            <button class="action-button" id="share-whatsapp">WhatsApp</button>
                            <button class="action-button" id="share-twitter">Twitter/X</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3 class="card-title">My Referrals</h3>
                    <div id="referrals-list"><p style="text-align:center; color:var(--secondary-text-color);">You haven't referred anyone yet.</p></div>
                </div>
            </div>
            
            <!-- === ‡¶®‡¶§‡ßÅ‡¶® Leaderboard View === -->
            <div id="leaderboard-view" class="view hidden">
                <div class="card">
                    <h3 class="card-title">üèÜ Leaderboard</h3>
                    <div id="leaderboard-list"><p style="text-align:center; color:var(--secondary-text-color);">Loading leaderboard...</p></div>
                </div>
            </div>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <!-- Navigation items are the same -->
        <div class="nav-item active" data-view="home-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</div>
        <div class="nav-item" data-view="tasks-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2m0 14H4V6h16zM6 10h4v4H6zm6 0h6v4h-6z"/></svg>Tasks</div>
        <div class="nav-item" data-view="shop-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 18c-1.11 0-2 .89-2 2s.89 2 2 2 2-.89 2-2-.89-2-2-2zm-12 0c-1.11 0-2 .89-2 2s.89 2 2 2 2-.89 2-2-.89-2-2-2zm1 0h10V4H6v14zM5.21 2.77L4.27 2H2v2h2.21l3.58 7.59-1.35 2.44A2 2 0 0 0 8 16h9v-2H8.53l1.1-2H15.7l3.58-6.41L18.63 4H19V2h-3.45z"/></svg>Shop</div>
        <div class="nav-item" data-view="bonus-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .35.07.69.18 1H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2m-8-1a1 1 0 0 1 1-1 1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1M12 19a3 3 0 0 1-3-3h6a3 3 0 0 1-3 3z"/></svg>Bonus</div>
        <div class="nav-item" data-view="withdraw-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2m14 14V8H5v10zm-7-7a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3z"/></svg>Withdraw</div>
        <div class="nav-item" data-view="history-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9m-1 5v5l4.25 2.52.75-1.23-3.5-2.08V8z"/></svg>History</div>
        <div class="nav-item" data-view="referral-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 11a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3m-8 0a5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5m0 8c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m11.5-3.5a2.5 2.5 0 0 0-2.5-2.5 2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5m-2.5 4c-1.95 0-5.8 1-5.8 3v1.5h11.6V20c0-2-3.85-3-5.8-3z"/></svg>Referral</div>
    </nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Firebase, Telegram Setup & Global Variables ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVNsMeB1jzOcIqAJjryUYmipT_SKrJi9k",
        authDomain: "giveawaybd.firebaseapp.com",
        databaseURL: "https://giveawaybd-default-rtdb.firebaseio.com",
        projectId: "giveawaybd",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    let currentUser = {}, appSettings = {};
    const userId = tg.initDataUnsafe?.user?.id || 'test_user_123'; 
    const userName = tg.initDataUnsafe?.user?.first_name || 'Test User';
    
    // --- Navigation ---
    const views = document.querySelectorAll('.view');
    const navItems = document.querySelectorAll('.nav-item');
    function navigate(viewId) {
        views.forEach(v => v.classList.add('hidden'));
        document.getElementById(viewId)?.classList.remove('hidden');
        navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
    }
    navItems.forEach(item => item.addEventListener('click', (e) => navigate(e.currentTarget.dataset.view)));
    document.querySelector('.leaderboard-nav-btn').addEventListener('click', () => navigate('leaderboard-view'));
    document.getElementById('go-to-shop-btn').addEventListener('click', () => navigate('shop-view'));
    
    // --- Main UI Update Function ---
    function updateUI(userData) {
        if (!userData) return;
        currentUser = userData;
        
        // Profile Card
        document.getElementById('user-name').textContent = userData.name || 'User';
        document.getElementById('welcome-name').textContent = userData.name || 'User';
        document.getElementById('user-points').textContent = `${userData.points || 0} Points`;
        document.getElementById('withdraw-balance').textContent = userData.points || 0;
        if (tg.initDataUnsafe?.user?.photo_url) {
            document.getElementById('profile-img').src = tg.initDataUnsafe.user.photo_url;
        } else {
            const initial = (userData.name || 'U').charAt(0).toUpperCase();
            document.querySelector('.profile-pic').innerHTML = `<span style="font-size: 32px; font-weight: bold;">${initial}</span>`;
        }

        // Stats
        document.getElementById('stats-total-ads').textContent = userData.stats?.totalAds || 0;
        document.getElementById('stats-referrals').textContent = userData.stats?.referrals || 0;
        
        // Notice
        const noticeCard = document.getElementById('notice-card');
        if (userData.notice) {
            noticeCard.classList.remove('hidden');
            document.getElementById('notice-text').innerText = userData.notice;
        } else {
            noticeCard.classList.add('hidden');
        }

        // Run feature-specific updates
        updateAdButtonStatus(userData.stats);
        renderDailyBonus(userData.bonus);
        loadHistory(); 
        loadReferrals();
        loadLeaderboard(); 
    }

    // --- Ads Logic ---
    function updateAdButtonStatus(stats = {}) {
        const today = new Date().toISOString().slice(0, 10);
        let adsWatchedToday = (stats.lastAdWatchedDate === today) ? (stats.adsWatched || 0) : 0;
        document.getElementById('stats-today-ads').textContent = adsWatchedToday;
        
        const dailyLimit = appSettings.dailyAdLimit || 20;
        const adsLeft = dailyLimit - adsWatchedToday;
        document.getElementById('ads-left-text').textContent = `You have ${adsLeft > 0 ? adsLeft : 0} ads left for today.`;
        
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const btnText = watchAdBtn.querySelector('span');
        if (adsLeft > 0) {
            watchAdBtn.disabled = false;
            btnText.textContent = 'Watch Ad';
        } else {
            watchAdBtn.disabled = true;
            btnText.textContent = 'Limit Reached';
        }
    }
    document.getElementById('watch-ad-btn').addEventListener('click', () => {
        const watchAdBtn = document.getElementById('watch-ad-btn');
        watchAdBtn.querySelector('span').textContent = 'Loading Ad...';
        
        window.showGiga();
        
        // Reset button state immediately as reward is server-side
        setTimeout(() => {
            watchAdBtn.querySelector('span').textContent = 'Watch Ad';
            // Button will be re-enabled/disabled by the next database update via updateAdButtonStatus
        }, 2000);
    });

    // --- Shop Logic ---
    window.handlePurchase = (itemType) => {
        const service = appSettings.shopItems?.[itemType] || { price: 100, min: 1, max: 1000 };
        const itemRoot = itemType;
        const link = document.getElementById(`shop-${itemRoot}-link`).value;
        const quantity = parseInt(document.getElementById(`shop-${itemRoot}-quantity`).value, 10);
        
        if (!link || !link.startsWith('https://t.me/')) { tg.showAlert('Please provide a valid Telegram link.'); return; }
        if (!quantity || quantity < service.min || quantity > service.max) { tg.showAlert(`Quantity must be between ${service.min} and ${service.max}.`); return; }
        
        const cost = quantity * service.price;
        if ((currentUser.points || 0) < cost) { tg.showAlert(`You need ${cost} points.`); return; }
        
        const newPoints = (currentUser.points || 0) - cost;
        const purchaseData = { userId, userName, itemType, quantity, cost, link, status: 'pending', purchasedAt: firebase.database.ServerValue.TIMESTAMP };
        
        db.ref('purchases').push(purchaseData)
            .then(() => db.ref(`users/${userId}/points`).set(newPoints))
            .then(() => {
                tg.showAlert(`Purchase request sent! It will be processed by an admin shortly.`);
            })
            .catch(error => tg.showAlert('An error occurred.'));
    };

    // --- Daily Bonus Logic ---
    const bonusGrid = document.getElementById('bonus-grid');
    const bonusProgress = document.getElementById('bonus-progress');
    const claimBonusBtn = document.getElementById('claim-bonus-btn');

    function renderDailyBonus(bonusData = {}) {
        const bonusPoints = appSettings.dailyBonusPoints || [];
        if (bonusPoints.length === 0) return;
        
        bonusGrid.innerHTML = '';
        const today = new Date().toISOString().slice(0, 10);
        let streak = bonusData.streak || 0;
        const lastClaimed = bonusData.lastClaimedDate || '';
        
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        if (lastClaimed && new Date(lastClaimed).toDateString() !== yesterday.toDateString() && lastClaimed !== today) {
            streak = 0; // Streak broken
        }

        let canClaim = lastClaimed !== today;

        for (let i = 0; i < 7; i++) {
            const day = i + 1;
            const points = bonusPoints[i] || 0;
            let cardClass = 'day-card';
            let icon = 'üéÅ';

            if (i < streak) {
                cardClass += ' claimed'; icon = '‚úÖ';
            } else if (i === streak && canClaim) {
                cardClass += ' active'; icon = '‚≠ê';
            } else {
                cardClass += ' locked'; icon = 'üîí';
            }
            bonusGrid.innerHTML += `<div class="${cardClass}"><div class="day">Day ${day}</div><div class="icon">${icon}</div><div class="points">${points}</div></div>`;
        }
        
        bonusProgress.style.width = `${(streak / 7) * 100}%`;
        
        if (canClaim && streak < 7) {
            claimBonusBtn.disabled = false;
            claimBonusBtn.textContent = `Claim ${bonusPoints[streak]} Points`;
        } else if (streak >= 7) {
            claimBonusBtn.disabled = true;
            claimBonusBtn.textContent = 'All Claimed!';
        } else {
            claimBonusBtn.disabled = true;
            claimBonusBtn.textContent = 'Wait For Next Day';
        }
    }
    claimBonusBtn.addEventListener('click', () => {
        claimBonusBtn.disabled = true;
        const userBonusRef = db.ref(`users/${userId}/bonus`);
        userBonusRef.once('value').then(snapshot => {
            const bonusData = snapshot.val() || { streak: 0 };
            const today = new Date().toISOString().slice(0, 10);
            if (bonusData.lastClaimedDate !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                let newStreak = 1;
                if(bonusData.lastClaimedDate && new Date(bonusData.lastClaimedDate).toDateString() === yesterday.toDateString()) {
                    newStreak = (bonusData.streak || 0) + 1;
                }
                if (newStreak > 7) newStreak = 1;

                const pointsToAdd = appSettings.dailyBonusPoints[newStreak - 1] || 0;
                db.ref().update({
                    [`users/${userId}/bonus/streak`]: newStreak,
                    [`users/${userId}/bonus/lastClaimedDate`]: today,
                    [`users/${userId}/points`]: firebase.database.ServerValue.increment(pointsToAdd)
                }).then(() => tg.HapticFeedback.notificationOccurred('success'));
            }
        });
    });

    // --- Withdraw & Other Buttons ---
    document.getElementById('submit-withdraw-btn').addEventListener('click', () => { const amount = parseInt(document.getElementById('withdraw-amount').value, 10); const method = document.getElementById('withdraw-method').value; const account = document.getElementById('withdraw-account').value; if (!appSettings.isWithdrawEnabled) { tg.showAlert("Withdrawal is currently disabled."); return; } if (!method) { tg.showAlert('No withdrawal method is available.'); return; } if (!amount || amount < (appSettings.minWithdraw || 0) || amount > (appSettings.maxWithdraw || 999999) || !account) { tg.showAlert(`Please check the amount (Min: ${appSettings.minWithdraw || 0}, Max: ${appSettings.maxWithdraw || 'N/A'}) and account details.`); return; } if ((currentUser.points || 0) < amount) { tg.showAlert("You don't have enough points."); return; } db.ref('withdrawals').push({ userId, userName, amount, method, account, status: 'pending', requestedAt: firebase.database.ServerValue.TIMESTAMP }).then(() => db.ref(`users/${userId}/points`).transaction(p => p - amount)).then(() => { tg.showAlert('Your request has been submitted successfully!'); if (appSettings.adminWhatsappGroupUrl) { tg.openLink(appSettings.adminWhatsappGroupUrl); } }); });
    document.getElementById('join-channel-btn').addEventListener('click', () => { if (appSettings.joinChannelUrl) tg.openLink(appSettings.joinChannelUrl); });
    document.getElementById('theme-toggle').addEventListener('click', () => { const newTheme = document.body.classList.contains('light') ? 'dark' : 'light'; document.body.className = newTheme; localStorage.setItem('theme', newTheme); tg.setHeaderColor(newTheme === 'dark' ? '#1f2937' : '#f3f4f6'); });
    
    // --- === ‡¶®‡¶§‡ßÅ‡¶® History, Referral, Leaderboard ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® === ---
    function loadHistory() {
        const historyList = document.getElementById('history-list');
        db.ref('withdrawals').orderByChild('userId').equalTo(userId).limitToLast(20).on('value', snapshot => {
            if (!snapshot.exists()) {
                historyList.innerHTML = '<p style="text-align:center; color:var(--secondary-text-color);">No withdrawal history.</p>'; return;
            }
            historyList.innerHTML = '';
            snapshot.forEach(child => {
                const data = child.val();
                const date = new Date(data.requestedAt).toLocaleDateString();
                historyList.innerHTML = `<div class="list-item">
                    <div class="info">
                        <div class="name">${data.amount} Points - ${data.method}</div>
                        <div class="details">${date} - <span class="status status-${data.status}">${data.status}</span></div>
                    </div>
                </div>` + historyList.innerHTML;
            });
        });
    }

    function loadReferrals() {
        if (appSettings.referralCommission) {
            document.getElementById('referral-commission-badge').textContent = `${appSettings.referralCommission}%`;
        }
        const refLinkInput = document.getElementById('referral-link');
        const refLink = `https://t.me/${appSettings.botUsername}?start=${currentUser.referralCode}`;
        refLinkInput.value = refLink;

        document.getElementById('share-telegram').onclick = () => tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(refLink)}`);
        document.getElementById('share-whatsapp').onclick = () => window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(refLink)}`, '_blank');
        document.getElementById('share-twitter').onclick = () => window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(refLink)}`, '_blank');

        const referralsList = document.getElementById('referrals-list');
        db.ref('users').orderByChild('referredBy').equalTo(userId).on('value', snapshot => {
            if (!snapshot.exists()) {
                referralsList.innerHTML = '<p style="text-align:center; color:var(--secondary-text-color);">You haven\'t referred anyone yet.</p>'; return;
            }
            referralsList.innerHTML = '';
            snapshot.forEach(child => {
                const data = child.val();
                referralsList.innerHTML += `<div class="list-item">
                    <div class="p-pic">${(data.name || 'U').charAt(0).toUpperCase()}</div>
                    <div class="info">
                        <div class="name">${data.name || 'Unknown User'}</div>
                        <div class="details">Joined: ${new Date(data.createdAt).toLocaleDateString()}</div>
                    </div>
                </div>`;
            });
        });
    }

    function loadLeaderboard() {
        const leaderboardList = document.getElementById('leaderboard-list');
        db.ref('users').orderByChild('points').limitToLast(10).on('value', snapshot => {
            if (!snapshot.exists()) {
                leaderboardList.innerHTML = '<p style="text-align:center; color:var(--secondary-text-color);">Leaderboard is empty.</p>'; return;
            }
            leaderboardList.innerHTML = '';
            let users = [];
            snapshot.forEach(child => users.push({ id: child.key, ...child.val() }));
            users.reverse().forEach((user, index) => {
                const rank = index + 1;
                leaderboardList.innerHTML += `
                    <div class="list-item leaderboard-item" onclick="window.Telegram.WebApp.openTelegramLink('https://t.me/${appSettings.botUsername}?start=user_${user.id}')">
                        <div class="rank">#${rank}</div>
                        <div class="p-pic">${(user.name || 'U').charAt(0).toUpperCase()}</div>
                        <div class="info">
                            <div class="name">${user.name || 'Unknown User'}</div>
                            <div class="details">${user.points || 0} Points „Éª ${user.stats?.referrals || 0} Referrals</div>
                        </div>
                    </div>`;
            });
        });
    }
    
    // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
    function initializeApp() {
        db.ref('settings').on('value', (snapshot) => {
            if (snapshot.exists()) {
                appSettings = snapshot.val();
                
                // General Settings
                document.getElementById('min-withdraw').textContent = appSettings.minWithdraw || '...';
                document.getElementById('max-withdraw').textContent = appSettings.maxWithdraw || '...';
                if(appSettings.shopItems?.members) {
                    const memberService = appSettings.shopItems.members;
                    document.getElementById('shop-members-details').textContent = `Price: ${memberService.price} pts/member „Éª Min: ${memberService.min} / Max: ${memberService.max}`;
                }
                
                // Withdrawal Methods
                const methodSelect = document.getElementById('withdraw-method');
                methodSelect.innerHTML = '';
                if (appSettings.isWithdrawEnabled && appSettings.withdrawalMethods) {
                    document.getElementById('withdraw-card').classList.remove('hidden');
                    document.getElementById('withdraw-disabled-card').classList.add('hidden');
                    Object.values(appSettings.withdrawalMethods).forEach(method => {
                        if (method.enabled) {
                            const option = document.createElement('option');
                            option.value = method.name;
                            option.textContent = method.name;
                            methodSelect.appendChild(option);
                        }
                    });
                } else {
                    document.getElementById('withdraw-card').classList.add('hidden');
                    document.getElementById('withdraw-disabled-card').classList.remove('hidden');
                }
                
                // Update UI based on new settings
                if (currentUser.id) updateUI(currentUser);
            }
        });

        db.ref(`users/${userId}`).on('value', (snapshot) => {
            if (snapshot.exists()) {
                updateUI(snapshot.val());
            } else {
                const urlParams = new URLSearchParams(tg.initData);
                const startParam = urlParams.get('start');
                const referredBy = startParam && startParam.startsWith('REF') ? startParam : null;

                const newUser = { 
                    id: userId, name: userName, points: 0, 
                    referralCode: 'REF' + Math.random().toString(36).substring(2, 8).toUpperCase(),
                    stats: { totalAds: 0, referrals: 0 }, 
                    bonus: { streak: 0 }, 
                    referredBy: referredBy,
                    createdAt: new Date().toISOString() 
                };
                db.ref(`users/${userId}`).set(newUser).then(() => {
                    if(referredBy) {
                        db.ref(`users/${referredBy}/stats/referrals`).transaction(r => (r || 0) + 1);
                    }
                    updateUI(newUser);
                });
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.className = savedTheme;
        tg.setHeaderColor(savedTheme === 'dark' ? '#1f2937' : '#f3f4f6');
        navigate('home-view');
    }
    
    initializeApp();
});
</script>
</body>
</html>```

### **‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡ßã‡¶°‡ßá ‡¶ï‡ßÄ ‡¶ï‡ßÄ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá:**

1.  **"Loading Ad..." ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®:** ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã‡¶∞ ‡ß® ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡ßü ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø `setTimeout` ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶Æ‡ßü‡¶ø‡¶ï ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®, ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶π‡ßü ‡¶è‡¶¨‡¶Ç UI ‡¶∏‡ßç‡¶¨‡ßü‡¶Ç‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡ßü‡•§

2.  **Withdraw History:**
    *   `history-view` ‡¶®‡¶æ‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶ú ‡¶è‡¶¨‡¶Ç `loadHistory` ‡¶®‡¶æ‡¶Æ‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
    *   ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø `withdrawals` ‡¶®‡ßã‡¶° ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∏‡¶¨ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® (pending, approved, rejected) ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßÅ‡¶®‡ßç‡¶¶‡¶∞‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡ßü‡•§

3.  **‡¶®‡¶§‡ßÅ‡¶® Leaderboard:**
    *   `leaderboard-view` ‡¶®‡¶æ‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶∏‡¶π ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
    *   `loadLeaderboard` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø Firebase ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶¨‡¶ö‡ßá‡ßü‡ßá ‡¶¨‡ßá‡¶∂‡¶ø ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶•‡¶æ‡¶ï‡¶æ ‡ßß‡ß¶ ‡¶ú‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶¶‡ßá‡¶ñ‡¶æ‡ßü‡•§
    *   ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡¶≤‡ßá ‡¶§‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶ñ‡ßã‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø `openTelegramLink` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§

4.  **‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶§‡ßÅ‡¶® Referral Page:**
    *   `referral-view` ‡¶®‡¶æ‡¶Æ‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶Æ‡¶§‡ßã ‡¶è‡¶ï‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
    *   ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï, ‡¶∂‡ßá‡ßü‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶è‡¶¨‡¶Ç ‡¶§‡¶æ‡¶∞ ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§
    *   `loadReferrals` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶è‡¶á ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶∏‡¶¨ ‡¶§‡¶•‡ßç‡¶Ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá‡•§

5.  **‡¶∏‡¶†‡¶ø‡¶ï Referral System:**
    *   ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶Ø‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶¨‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßá, ‡¶§‡¶ñ‡¶® ‡¶ï‡ßã‡¶°‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá ‡¶Ø‡ßá ‡¶∏‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï (`?start=REF...`) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶è‡¶∏‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ‡•§
    *   ‡¶Ø‡¶¶‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶∏‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶§‡ßá `referredBy` ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡¶æ‡¶∞‡ßá‡¶∞ `referrals` ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡ßß ‡¶¨‡¶æ‡ßú‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶¨‡ßá‡•§

6.  **Shop Approval Bug Fix:**
    *   `handlePurchase` ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶∞‡ßá ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶Ø‡ßá ‡¶è‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá `purchases` ‡¶®‡ßã‡¶°‡ßá `status: 'pending'` ‡¶∏‡¶π ‡¶°‡ßá‡¶ü‡¶æ ‡¶™‡¶æ‡¶†‡¶æ‡¶ö‡ßç‡¶õ‡ßá‡•§

**‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶™‡¶¶‡¶ï‡ßç‡¶∑‡ßá‡¶™:**
‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ `index.html` ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§‡•§ ‡¶è‡¶∞‡¶™‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ **`admin.html` ‡¶´‡¶æ‡¶á‡¶≤** ‡¶è‡¶¨‡¶Ç **‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶¨‡¶ü‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶° ‡¶ï‡ßã‡¶°** ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá ‡¶Ø‡¶æ‡¶§‡ßá ‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® ‡¶¶‡ßá‡¶ì‡ßü‡¶æ, ‡¶∂‡¶™-‡¶è‡¶∞ ‡¶Ü‡¶á‡¶ü‡ßá‡¶Æ ‡¶®‡¶ø‡ßü‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ) ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡ßá‡•§

**‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ `admin.html` ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶¶‡¶ø‡¶®‡•§** ‡¶Ü‡¶Æ‡¶ø ‡¶∏‡ßá‡¶ü‡¶ø‡¶ï‡ßá ‡¶è‡¶á ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶ø‡¶ö‡¶æ‡¶∞‡¶ó‡ßÅ‡¶≤‡ßã ‡¶®‡¶ø‡ßü‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶£ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶â‡¶™‡¶Ø‡ßã‡¶ó‡ßÄ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡¶¨‡•§
