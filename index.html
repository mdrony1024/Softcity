<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Softcity</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- === GIGAPUB SDK === -->
    <script src="https://ad.gigapub.tech/script?id=1327"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --gradient-start: #7f52ff; --gradient-end: #d152ff;
            --light-bg: #f3f4f6; --light-card-bg: #ffffff; --light-text: #111827;
            --light-secondary-text: #6b7280; --light-border: #e5e7eb;
            --dark-bg: #1f2937; --dark-card-bg: #374151; --dark-text: #f9fafb;
            --dark-secondary-text: #9ca3af; --dark-border: #4b5563;
            --accent-color: #5856d6; --accent-hover: #4c4ac6; --gold: #ffc700;
            --silver: #c0c0c0; --bronze: #cd7f32;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0 0 100px 0; transition: background-color 0.3s, color 0.3s; }
        body.light { --bg-color: var(--light-bg); --card-bg-color: var(--light-card-bg); --text-color: var(--light-text); --secondary-text-color: var(--light-secondary-text); --border-color: var(--light-border); }
        body.dark { --bg-color: var(--dark-bg); --card-bg-color: var(--dark-card-bg); --text-color: var(--dark-text); --secondary-text-color: var(--dark-secondary-text); --border-color: var(--dark-border); }
        body { background-color: var(--bg-color); color: var(--text-color); }
        .container { width: 100%; max-width: 500px; margin: 0 auto; padding: 0 15px; box-sizing: border-box; }
        .hidden { display: none !important; }
        .view { animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; }
        .top-header .title { font-size: 20px; font-weight: 600; }
        #theme-toggle { background: var(--card-bg-color); border: 1px solid var(--border-color); color: var(--text-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 18px; }
        .header-bg { background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); height: 120px; border-radius: 0 0 30px 30px; margin: 0 -15px 0 -15px; position: absolute; top: 0; left: 0; right: 0; z-index: -1; }
        .profile-card { background: var(--card-bg-color); border-radius: 20px; padding: 20px; text-align: center; margin-top: 50px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); position: relative; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: -60px auto 10px; border: 4px solid var(--card-bg-color); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .profile-pic img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .profile-pic-initial { font-size: 32px; font-weight: bold; color: var(--accent-color); }
        #user-name { font-size: 20px; font-weight: 600; }
        #user-points { background-color: var(--accent-color); color: white; padding: 5px 15px; border-radius: 20px; display: inline-block; font-size: 14px; margin-top: 5px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .stat-item .value { font-size: 18px; font-weight: 600; }
        .stat-item .label { font-size: 12px; color: var(--secondary-text-color); }
        .action-button { width: 100%; padding: 12px; background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .action-button:hover { background-color: var(--accent-hover); color: white; border-color: var(--accent-hover); }
        .action-button:disabled { background-color: #ccc; border-color: #ccc; color: #666; cursor: not-allowed; }
        .card { background: var(--card-bg-color); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; }
        .notice-card { background-color: var(--accent-color); color: white; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 12px; box-sizing: border-box; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-color); font-size: 14px; }
        .shop-item { border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; margin-bottom: 15px; }
        .shop-item h4 { margin-top: 0; }
        .price-tag { font-size: 12px; color: var(--secondary-text-color); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--card-bg-color); display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); border-top: 1px solid var(--border-color); z-index: 100; flex-wrap: wrap; }
        .nav-item { cursor: pointer; text-align: center; color: var(--secondary-text-color); font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; transition: color 0.2s; padding: 0 5px; flex-basis: 0; flex-grow: 1; }
        .nav-item.active { color: var(--accent-color); }
        .nav-item svg { width: 24px; height: 24px; }
        
        /* --- STYLES FOR DIFFERENT SECTIONS --- */
        .bonus-container { padding: 20px; background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end)); border-radius: 15px; color: white; }
        .bonus-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .day-card { background: rgba(255, 255, 255, 0.2); border-radius: 10px; padding: 10px; text-align: center; transition: transform 0.2s; }
        .day-card.active { border: 2px solid white; transform: scale(1.05); }
        .day-card.claimed { background: rgba(130, 255, 130, 0.4); }
        .day-card.locked { opacity: 0.6; }
        .day-card .day { font-size: 12px; }
        .day-card .icon { font-size: 24px; margin: 5px 0; }
        .day-card .points { font-size: 16px; font-weight: bold; }
        #claim-bonus-btn { background-color: white; color: var(--accent-color); margin-top: 20px; font-weight: bold; }
        
        #leaderboard-list { display: flex; flex-direction: column; gap: 10px; }
        .leaderboard-item { display: flex; align-items: center; background-color: var(--card-bg-color); padding: 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .leaderboard-rank { font-size: 18px; font-weight: 700; color: var(--secondary-text-color); width: 40px; text-align: center; }
        .leaderboard-pic { width: 45px; height: 45px; border-radius: 50%; margin: 0 10px; object-fit: cover; background-color: #eee; }
        .leaderboard-info { flex-grow: 1; }
        .leaderboard-item.rank-1 { border-color: var(--gold); }
        .leaderboard-item.rank-2 { border-color: var(--silver); }
        .leaderboard-item.rank-3 { border-color: var(--bronze); }
        
        #history-list { display: flex; flex-direction: column; gap: 12px; }
        .history-item { border: 1px solid var(--border-color); padding: 15px; border-radius: 10px; }
        .history-item-header { display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .history-item-details { font-size: 12px; color: var(--secondary-text-color); margin-top: 5px; }
        .status-pending { color: #f59e0b; }
        .status-completed, .status-approved { color: #10b981; }
        .status-rejected { color: #ef4444; }

        /* --- NEW REFERRAL PAGE STYLES --- */
        .referral-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .referral-header h3 { margin: 0; font-size: 22px; font-weight: 600; border-bottom: none; }
        .referral-header .commission-badge { background-color: var(--accent-color); color: white; font-size: 14px; font-weight: 600; padding: 6px 12px; border-radius: 20px; }
        .referral-steps { display: flex; flex-direction: column; gap: 15px; margin-top: 25px; }
        .step-item { display: flex; align-items: center; gap: 15px; }
        .step-icon { width: 40px; height: 40px; border-radius: 50%; background-color: color-mix(in srgb, var(--accent-color) 15%, transparent); display: flex; align-items: center; justify-content: center; font-size: 20px; color: var(--accent-color); flex-shrink: 0; }
        .step-text h4 { margin: 0; font-size: 16px; }
        .step-text p { margin: 0; font-size: 13px; color: var(--secondary-text-color); }
        .referral-link-box { margin-top: 30px; }
        .referral-link-box label { font-weight: 600; margin-bottom: 8px; display: block; }
        .referral-link-input-wrapper { display: flex; align-items: center; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 5px; }
        #referral-link { border: none; background: transparent; flex-grow: 1; padding: 10px; font-size: 14px; }
        #copy-link-btn { background: var(--accent-color); color: white; border: none; border-radius: 8px; padding: 10px 15px; cursor: pointer; font-size: 18px; }
        .share-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .share-btn { padding: 10px; border-radius: 8px; text-decoration: none; color: white; text-align: center; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .share-btn.telegram { background-color: #0088cc; }
        .share-btn.whatsapp { background-color: #25d366; }
        .share-btn.twitter { background-color: #1da1f2; }
        #referrals-list-container { margin-top: 20px; }
        #search-referrals { margin-bottom: 10px; }
        .referral-list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 8px; background-color: var(--bg-color); margin-bottom: 8px; }
    </style>
</head>
<body class="light">
    
    <div class="header-bg"></div>
    <div class="top-header container">
        <h1 class="title">Softcity 💸</h1>
        <button id="theme-toggle">🌙</button>
    </div>

    <div class="container">
        <!-- Views Wrapper -->
        <div id="views-container">
            <!-- Home View -->
            <div id="home-view" class="view">
                 <div class="profile-card">
                    <div class="profile-pic"><span class="profile-pic-initial"></span></div>
                    <h2 id="user-name">Loading...</h2>
                    <div id="user-points">0 Points</div>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="value" id="stats-today-ads">0</div><div class="label">Today's Ads</div></div>
                        <div class="stat-item"><div class="value" id="stats-total-ads">0</div><div class="label">Total Ads</div></div>
                        <div class="stat-item"><div class="value" id="stats-referrals">0</div><div class="label">Referrals</div></div>
                    </div>
                     <button class="action-button" id="leaderboard-btn" style="margin-top:15px;">🏆 Leaderboard</button>
                </div>

                <div id="notice-card" class="card notice-card hidden">
                    <h3 class="card-title" style="color: white;">📢 Notice</h3>
                    <p id="notice-text" style="font-size: 14px;"></p>
                 </div>

                <div class="card">
                    <h3 class="card-title">Welcome, <span id="welcome-name">User</span>!</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">Complete tasks, invite friends, and earn points.</p>
                    <button class="action-button" style="background-color: var(--accent-color); color: white;" id="join-channel-btn">🚀 Join Channel</button>
                </div>
            </div>

            <!-- Tasks View -->
            <div id="tasks-view" class="view hidden">
                <div class="card">
                    <h3 class="card-title">Promote Services</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">আপনার ব্যালেন্স দিয়ে আপনার চ্যানেল প্রোমোট করুন।</p>
                    <button class="action-button" id="go-to-shop-btn" style="margin-top: 15px;">🛍️ Go to Shop</button>
                </div>
                <div class="card">
                    <h3 class="card-title">Watch Ads & Earn</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;" id="ads-left-text">Loading...</p>
                    <button class="action-button" style="background-color: var(--accent-color); color: white;" id="watch-ad-btn" disabled>
                        <svg style="width:20px; height:20px;" viewBox="0 0 24 24"><path fill="currentColor" d="M22,10.45V13.55A1,1 0 0,1 21,14.55C20.84,14.55 20.68,14.5 20.53,14.43L18,13.35V16.5A1.5,1.5 0 0,1 16.5,18H3.5A1.5,1.5 0 0,1 2,16.5V7.5A1.5,1.5 0 0,1 3.5,6H16.5A1.5,1.5 0 0,1 18,7.5V10.65L20.53,9.57C20.83,9.44 21.17,9.5 21.39,9.73C21.5,9.84 21.56,10 21.56,10.15L22,10.45M10,10.5A1.5,1.5 0 0,0 8.5,12A1.5,1.5 0 0,0 10,13.5A1.5,1.5 0 0,0 11.5,12A1.5,1.5 0 0,0 10,10.5Z" /></svg>
                        <span>Watch Ad</span>
                    </button>
                </div>
            </div>

            <!-- Shop View -->
            <div id="shop-view" class="view hidden">
                 <div class="card">
                    <h3 class="card-title">🛒 Shop</h3>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">Use your points to buy services.</p>
                    <div id="shop-items-container"><p>Loading shop items...</p></div>
                </div>
            </div>

            <!-- Bonus View -->
            <div id="bonus-view" class="view hidden">
                <div class="card bonus-container">
                    <h3 class="card-title" style="color:white; border:none; text-align:center;">Daily Check-in Bonus</h3>
                    <p style="font-size: 14px; margin-top: -10px; text-align:center;">Claim your daily reward and keep your streak!</p>
                    <div id="bonus-grid" class="bonus-grid"></div>
                    <button class="action-button" id="claim-bonus-btn" disabled>Claim Reward</button>
                </div>
            </div>
            
            <!-- Withdraw & History Views -->
            <div id="withdraw-view" class="view hidden">
                <div class="card" id="withdraw-card">
                    <h3 class="card-title">Withdraw Points</h3>
                    <div class="form-group">
                        <label>Balance: <span id="withdraw-balance">0</span> points</label>
                        <label style="font-size:12px; color:var(--secondary-text-color)">Min: <span id="min-withdraw">...</span></label>
                        <input type="number" id="withdraw-amount" placeholder="e.g., 20000">
                    </div>
                    <div class="form-group">
                        <label for="withdraw-method">Method</label>
                        <select id="withdraw-method"></select>
                    </div>
                    <div class="form-group"><label for="withdraw-account">Account Details</label><input type="text" id="withdraw-account" placeholder="Your account number or ID"></div>
                    <button class="action-button" id="submit-withdraw-btn" style="background-color: var(--accent-color); color: white;">Submit Request</button>
                </div>
                <div class="card hidden" id="withdraw-disabled-card"><p>Withdrawal is temporarily disabled.</p></div>
            </div>
            <div id="history-view" class="view hidden" data-onshow="loadHistory">
                <div class="card">
                    <h3 class="card-title">Transaction History</h3>
                    <div id="history-list"><p>Loading history...</p></div>
                </div>
            </div>

            <!-- NEW: Referral View -->
            <div id="referral-view" class="view hidden" data-onshow="loadReferralsList">
                <div class="card">
                    <div class="referral-header">
                        <h3>Refer & Earn Forever</h3>
                        <span class="commission-badge">...%</span>
                    </div>
                    <p style="color:var(--secondary-text-color); font-size: 14px; margin-top: -10px;">Earn from your friends' earnings for life! Follow these simple steps:</p>
                    <div class="referral-steps">
                        <div class="step-item"><div class="step-icon">🔗</div><div class="step-text"><h4>1. Copy Your Link</h4><p>Grab your unique referral link below.</p></div></div>
                        <div class="step-item"><div class="step-icon">📤</div><div class="step-text"><h4>2. Share with Friends</h4><p>Use the buttons to share your link.</p></div></div>
                        <div class="step-item"><div class="step-icon">💰</div><div class="step-text"><h4>3. Earn Lifetime Rewards</h4><p>Get rewards from your friends' earnings forever.</p></div></div>
                    </div>
                    <div class="referral-link-box">
                        <label>Your Referral Link</label>
                        <div class="referral-link-input-wrapper">
                            <input type="text" id="referral-link" readonly>
                            <button id="copy-link-btn">📋</button>
                        </div>
                    </div>
                    <div class="share-buttons">
                        <a href="#" id="share-telegram" class="share-btn telegram">Telegram</a>
                        <a href="#" id="share-whatsapp" class="share-btn whatsapp">WhatsApp</a>
                        <a href="#" id="share-twitter" class="share-btn twitter">Twitter</a>
                    </div>
                </div>
                <div class="card" id="referrals-list-container">
                    <h3 class="card-title">My Referrals</h3>
                    <input type="text" id="search-referrals" placeholder="🔍 Search by username...">
                    <div id="referrals-list"><p>Loading your referrals...</p></div>
                </div>
            </div>
            
            <div id="leaderboard-page-view" class="view hidden" data-onshow="loadLeaderboard">
                 <!-- Leaderboard content will be loaded here -->
            </div>
        </div>
    </div>
    
    <nav class="bottom-nav">
        <div class="nav-item active" data-view="home-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Home</div>
        <div class="nav-item" data-view="tasks-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2m0 14H4V6h16zM6 10h4v4H6zm6 0h6v4h-6z"/></svg>Tasks</div>
        <div class="nav-item" data-view="bonus-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .35.07.69.18 1H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2m-8-1a1 1 0 0 1 1-1 1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1M12 19a3 3 0 0 1-3-3h6a3 3 0 0 1-3 3z"/></svg>Bonus</div>
        <div class="nav-item" data-view="withdraw-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2m14 14V8H5v10zm-7-7a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3z"/></svg>Withdraw</div>
        <div class="nav-item" data-view="history-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 0 1 7-7 7 7 0 0 1 7 7 7 7 0 0 1-7 7v2a9 9 0 0 0 9-9 9 9 0 0 0-9-9m-1 5v5l4.25 2.52.75-1.23-3.5-2.08V8z"/></svg>History</div>
        <div class="nav-item" data-view="referral-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 11a3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3m-8 0a5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5-5 5 5 0 0 1-5-5m0 8c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4m11.5-3.5a2.5 2.5 0 0 0-2.5-2.5 2.5 2.5 0 0 0-2.5 2.5 2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5m-2.5 4c-1.95 0-5.8 1-5.8 3v1.5h11.6V20c0-2-3.85-3-5.8-3z"/></svg>Referral</div>
    </nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Firebase & Telegram Setup ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVNsMeB1jzOcIqAJjryUYmipT_SKrJi9k",
        authDomain: "giveawaybd.firebaseapp.com",
        databaseURL: "https://giveawaybd-default-rtdb.firebaseio.com",
        projectId: "giveawaybd",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.BackButton.hide();

    // --- Global Variables ---
    let currentUser = {}; 
    let appSettings = {};
    const userId = tg.initDataUnsafe?.user?.id || 'test_user_12345';
    const userName = tg.initDataUnsafe?.user?.first_name || 'Test User';
    let userReferrals = [];
    
    const views = document.querySelectorAll('.view');
    const navItems = document.querySelectorAll('.nav-item');

    // --- Navigation ---
    function navigate(viewId) {
        views.forEach(v => v.classList.add('hidden'));
        const targetView = document.getElementById(viewId);
        if (targetView) targetView.classList.remove('hidden');
        navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewId));
        
        tg.BackButton.hide();
        if (viewId === 'leaderboard-page-view') tg.BackButton.show();
        
        if (targetView.dataset.onshow) window[targetView.dataset.onshow]();
    }

    // --- UI Update Functions ---
    function updateUI(userData) {
        if (!userData) return;
        currentUser = userData;
        
        document.getElementById('user-name').textContent = userData.name || 'User';
        document.getElementById('welcome-name').textContent = userData.name || 'User';
        document.getElementById('user-points').textContent = `${userData.points || 0} Points`;
        document.getElementById('withdraw-balance').textContent = userData.points || 0;
        
        const profilePicDiv = document.querySelector('.profile-pic');
        if (tg.initDataUnsafe?.user?.photo_url) {
            profilePicDiv.innerHTML = `<img src="${tg.initDataUnsafe.user.photo_url}" alt="P">`;
        } else {
            profilePicDiv.innerHTML = `<span class="profile-pic-initial">${(userData.name || 'U').charAt(0).toUpperCase()}</span>`;
        }
        
        document.getElementById('stats-total-ads').textContent = userData.stats?.totalAdsWatched || 0;
        document.getElementById('stats-referrals').textContent = userData.stats?.referrals || 0;
        
        if (appSettings.botUsername && userData.referralCode) {
            const referralLink = `https://t.me/${appSettings.botUsername}?start=${userData.referralCode}`;
            document.getElementById('referral-link').value = referralLink;
            const shareText = encodeURIComponent(`Join me on ${appSettings.appName || 'Softcity'} and earn rewards!`);
            document.getElementById('share-telegram').href = `https://t.me/share/url?url=${encodeURIComponent(referralLink)}&text=${shareText}`;
            document.getElementById('share-whatsapp').href = `https://api.whatsapp.com/send?text=${shareText} ${encodeURIComponent(referralLink)}`;
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?text=${shareText}&url=${encodeURIComponent(referralLink)}`;
        }
        
        document.querySelector('.commission-badge').textContent = `${appSettings.referralCommission || 20}%`;
        
        const noticeCard = document.getElementById('notice-card');
        if (appSettings.notice) {
            noticeCard.classList.remove('hidden');
            document.getElementById('notice-text').innerText = appSettings.notice;
        } else {
            noticeCard.classList.add('hidden');
        }

        updateAdButtonStatus(userData.stats);
        renderDailyBonus(userData.bonus);
    }

    function updateAdButtonStatus(stats) {
        const today = new Date().toISOString().slice(0, 10);
        let adsWatchedToday = (stats && stats.lastAdWatchedDate === today) ? (stats.adsWatchedToday || 0) : 0;
        const dailyLimit = appSettings.dailyAdLimit || 999;
        const adsLeft = dailyLimit - adsWatchedToday;
        
        document.getElementById('ads-left-text').textContent = `You have ${adsLeft > 0 ? adsLeft : 0} ads left for today.`;
        const watchAdBtn = document.getElementById('watch-ad-btn');
        watchAdBtn.disabled = !(adsLeft > 0);
        watchAdBtn.querySelector('span').textContent = adsLeft > 0 ? 'Watch Ad' : 'Limit Reached';
    }
    
    function renderShopItems() { /* ... unchanged ... */ }

    // --- Data Loading Functions ---
    window.loadLeaderboard = () => { /* ... unchanged ... */ };
    
    window.loadHistory = function() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '<p>Loading history...</p>';

        const withdrawalsPromise = db.ref('withdrawals').orderByChild('userId').equalTo(String(userId)).once('value');
        const purchasesPromise = db.ref('purchases').orderByChild('userId').equalTo(String(userId)).once('value');

        Promise.all([withdrawalsPromise, purchasesPromise]).then(([withdrawalsSnap, purchasesSnap]) => {
            let combinedList = [];
            withdrawalsSnap.forEach(child => combinedList.push({ type: 'Withdrawal', ...child.val() }));
            purchasesSnap.forEach(child => combinedList.push({ type: 'Purchase', ...child.val() }));

            if (combinedList.length === 0) {
                historyList.innerHTML = '<p>No transaction history found.</p>';
                return;
            }

            combinedList.sort((a, b) => (b.requestedAt || b.createdAt) - (a.requestedAt || a.createdAt));
            historyList.innerHTML = '';
            combinedList.forEach(item => {
                const date = new Date(item.requestedAt || item.createdAt).toLocaleString();
                const statusClass = `status-${(item.status || 'pending').toLowerCase()}`;
                let title = '', details = '';
                
                if (item.type === 'Withdrawal') {
                    title = `Withdrawal: ${item.amount} Points`;
                    details = `To: ${item.account} (${item.method})`;
                } else {
                    title = `Purchase: ${item.quantity} ${item.itemType}`;
                    details = `Cost: ${item.cost} Points`;
                }

                historyList.innerHTML += `<div class="history-item"><div class="history-item-header"><span>${title}</span><span class="${statusClass}">${item.status}</span></div><div class="history-item-details">${details} &bull; ${date}</div></div>`;
            });

        }).catch(err => {
            console.error("Error loading history:", err);
            historyList.innerHTML = '<p>Could not load history. Please try again.</p>';
        });
    };

    window.loadReferralsList = function() {
        const listEl = document.getElementById('referrals-list');
        listEl.innerHTML = '<p>Loading your referrals...</p>';
        
        db.ref('users').orderByChild('referredBy').equalTo(String(userId)).once('value', snapshot => {
            if (!snapshot.exists()) {
                listEl.innerHTML = '<p>You haven\'t referred anyone yet.</p>';
                userReferrals = [];
                return;
            }
            userReferrals = [];
            snapshot.forEach(child => userReferrals.push(child.val()));
            renderReferrals(userReferrals);
        });
    };
    
    function renderReferrals(referralsToRender) {
         const listEl = document.getElementById('referrals-list');
         if(referralsToRender.length === 0) {
             listEl.innerHTML = '<p>No matching referrals found.</p>';
             return;
         }
         listEl.innerHTML = '';
         referralsToRender.forEach(ref => {
             listEl.innerHTML += `<div class="referral-list-item"><span>${ref.name || 'Unnamed User'}</span><span>${ref.points || 0} Points</span></div>`;
         });
    }
    
    document.getElementById('search-referrals').addEventListener('input', e => {
        const searchTerm = e.target.value.toLowerCase();
        renderReferrals(userReferrals.filter(ref => (ref.name || '').toLowerCase().includes(searchTerm)));
    });

    window.handlePurchase = (itemKey) => { /* ... unchanged ... */ };

    // --- Event Listeners & Actions ---
    navItems.forEach(item => item.addEventListener('click', (e) => navigate(e.currentTarget.dataset.view)));
    document.getElementById('leaderboard-btn').addEventListener('click', () => navigate('leaderboard-page-view'));
    document.getElementById('go-to-shop-btn').addEventListener('click', () => navigate('shop-view'));
    document.getElementById('join-channel-btn').addEventListener('click', () => { if (appSettings.joinChannelUrl) tg.openLink(appSettings.joinChannelUrl); });
    
    document.getElementById('copy-link-btn').addEventListener('click', () => {
        const linkInput = document.getElementById('referral-link');
        linkInput.select();
        document.execCommand('copy');
        tg.HapticFeedback.notificationOccurred('success');
        tg.showAlert("Referral link copied!");
    });

    tg.onEvent('backButtonClicked', () => navigate('home-view'));

    document.getElementById('theme-toggle').addEventListener('click', () => {
        document.body.classList.toggle('dark');
        localStorage.setItem('theme', document.body.className);
        tg.setHeaderColor(document.body.classList.contains('dark') ? '#1f2937' : '#f3f4f6');
    });

    document.getElementById('watch-ad-btn').addEventListener('click', () => { /* ... same as previous correct version ... */ });
    document.getElementById('submit-withdraw-btn').addEventListener('click', () => { /* ... unchanged ... */ });
    
    // Daily Bonus Logic
    function renderDailyBonus(bonusData = {}) { /* ... unchanged ... */ }
    claimBonusBtn.addEventListener('click', () => { /* ... unchanged ... */ });

    // --- Referral System Functions ---
    function handleReferral(startParam) {
        if (!startParam || !startParam.startsWith('REF')) return;
        const referrerCode = startParam;
        db.ref('users').orderByChild('referralCode').equalTo(referrerCode).limitToFirst(1).once('value', snapshot => {
            if (snapshot.exists()) {
                let referrerId;
                snapshot.forEach(child => { referrerId = child.key; });
                if (referrerId && referrerId != userId) {
                    db.ref(`users/${userId}/referredBy`).set(referrerId);
                    db.ref(`users/${referrerId}/stats/referrals`).set(firebase.database.ServerValue.increment(1));
                }
            }
        });
    }

    function giveReferralCommission(earnedPoints) {
        if (!currentUser.referredBy) return;
        const commissionRate = (appSettings.referralCommission || 20) / 100;
        const commissionAmount = Math.floor(earnedPoints * commissionRate);
        if (commissionAmount > 0) {
            db.ref(`users/${currentUser.referredBy}/points`).set(firebase.database.ServerValue.increment(commissionAmount));
        }
    }

    // --- App Initialization ---
    function initializeApp() {
        db.ref('settings').on('value', (snapshot) => {
            if (snapshot.exists()) {
                appSettings = snapshot.val();
                document.title = appSettings.appName || 'Softcity';
                document.querySelector('.top-header .title').textContent = appSettings.appName || 'Softcity 💸';
                document.getElementById('min-withdraw').textContent = appSettings.minWithdraw || '...';

                const methodSelect = document.getElementById('withdraw-method');
                methodSelect.innerHTML = '';
                if (appSettings.isWithdrawEnabled && appSettings.withdrawalMethods) {
                    Object.values(appSettings.withdrawalMethods).forEach(method => {
                        if (method.enabled) methodSelect.innerHTML += `<option value="${method.name}">${method.name}</option>`;
                    });
                }
                document.getElementById('withdraw-card').classList.toggle('hidden', !appSettings.isWithdrawEnabled);
                document.getElementById('withdraw-disabled-card').classList.toggle('hidden', appSettings.isWithdrawEnabled);
                
                renderShopItems();
                if (currentUser.id) updateUI(currentUser);
            }
        });

        db.ref(`users/${userId}`).once('value', (snapshot) => {
            if (snapshot.exists()) {
                db.ref(`users/${userId}`).on('value', (snap) => updateUI(snap.val()));
            } else {
                const referralCode = 'REF' + Math.random().toString(36).substring(2, 8).toUpperCase();
                const newUser = { 
                    id: String(userId), name: userName, points: 0, referralCode, 
                    stats: { totalAdsWatched: 0, adsWatchedToday: 0, referrals: 0 }, 
                    bonus: { streak: 0 }, createdAt: new Date().toISOString() 
                };
                db.ref(`users/${userId}`).set(newUser).then(() => {
                    const startParam = tg.initDataUnsafe?.start_param;
                    if(startParam) handleReferral(startParam);
                    db.ref(`users/${userId}`).on('value', (snap) => updateUI(snap.val()));
                });
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.className = savedTheme;
        tg.setHeaderColor(savedTheme === 'dark' ? '#1f2937' : '#f3f4f6');
        
        navigate('home-view');
    }
    
    initializeApp();
});
</script>
</body>
</html>
