<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #1c1e21; }
        .container { max-width: 1200px; margin: auto; }
        #login-view, #admin-view { display: none; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        h1, h2, h3 { color: #1c1e21; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: middle; word-break: break-all; }
        th { background-color: #f5f6f7; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-approve { background-color: #42b72a; color: white; }
        .btn-reject { background-color: #fa3e3e; color: white; }
        .btn-edit { background-color: #1877f2; color: white; }
        .btn-save { background-color: #f5a623; color: white; }
        .btn-delete { background-color: #e02828; color: white; }
        .btn-add { background-color: #36a420; color: white; margin-top: 10px; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .actions-cell { display: flex; gap: 5px; flex-wrap: wrap;}
        .setting-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .setting-item { margin-bottom: 15px; }
        .method-item { display: grid; grid-template-columns: 1fr 120px 80px; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; border-radius: 6px; }
        .status-pending { color: #f5a623; font-weight: bold; }
        .status-approved { color: #42b72a; font-weight: bold; }
        .status-rejected { color: #fa3e3e; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login View -->
        <div id="login-view" style="display: block; max-width: 400px; margin: 100px auto;">
            <div class="card">
                <h1>Admin Login</h1>
                <input type="text" id="username-input" placeholder="Username">
                <input type="password" id="password-input" placeholder="Password">
                <button id="login-btn" class="btn btn-edit" style="width: 100%;">Login</button>
            </div>
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-view">
            <h1>Admin Dashboard</h1>

            <!-- Settings Section -->
            <div class="card">
                <h2>App Settings</h2>
                <div class="setting-grid">
                    <div class="setting-item">
                        <label for="app-name-input">App Name</label>
                        <input type="text" id="app-name-input" placeholder="Your App Name">
                    </div>
                     <div class="setting-item">
                        <label for="points-per-ad-input">Points Per Ad</label>
                        <input type="number" id="points-per-ad-input" placeholder="e.g., 10">
                    </div>
                    <div class="setting-item">
                        <label for="daily-ad-limit-input">Daily Ad Limit Per User</label>
                        <input type="number" id="daily-ad-limit-input" placeholder="e.g., 20">
                    </div>
                    <div class="setting-item">
                        <label for="min-withdraw-input">Minimum Withdraw Points</label>
                        <input type="number" id="min-withdraw-input" placeholder="e.g., 10000">
                    </div>
                    <div class="setting-item">
                        <label for="max-withdraw-input">Maximum Withdraw Points</label>
                        <input type="number" id="max-withdraw-input" placeholder="e.g., 50000">
                    </div>
                    <div class="setting-item">
                        <label>Withdrawals Enabled:</label>
                        <select id="withdraw-enabled-select">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                </div>
                <hr>
                <h3>Withdrawal Methods</h3>
                <div id="withdrawal-methods-container"></div>
                <button id="add-method-btn" class="btn btn-add">Add New Method</button>
                <hr>
                
                <!-- === নতুন ডেইলি বোনাস সেটিংস এখানে যোগ করা হয়েছে === -->
                <h3>Daily Check-in Bonus Points (7 Days)</h3>
                <p style="font-size: 12px; color: #666;">Set the points for each day of the daily check-in streak. Leave 0 if no bonus for a day.</p>
                <div id="daily-bonus-container" class="setting-grid">
                    <!-- Day inputs will be generated by JavaScript -->
                </div>
                <!-- === নতুন ডেইলি বোনাস সেটিংস শেষ === -->
                
                <hr style="margin-top: 20px;">
                <button id="save-settings-btn" class="btn btn-save" style="width: 100%;">Save All Settings</button>
            </div>

            <!-- Notice Section -->
            <div class="card">
                <h2>Send Notice to All Users</h2>
                <textarea id="notice-input" rows="3" placeholder="Enter your notice here..."></textarea>
                <button id="send-notice-btn" class="btn btn-edit">Send Notice</button>
                <button id="remove-notice-btn" class="btn btn-reject">Remove Notice</button>
            </div>
            
            <!-- === নতুন Shop Orders সেকশন যোগ করা হয়েছে === -->
            <div class="card">
                <h2>Pending Shop Orders</h2>
                <table id="purchases-table">
                    <thead><tr><th>Date</th><th>User</th><th>Item</th><th>Link</th><th>Cost</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Users Section -->
            <div class="card">
                <h2>Manage Users</h2>
                <input type="text" id="search-user-input" placeholder="Search by User ID or Name...">
                <table id="users-table">
                    <thead><tr><th>User ID</th><th>Name</th><th>Points</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Withdrawals Section -->
            <div class="card">
                <h2>Pending Withdrawals</h2>
                <table id="withdrawals-table">
                    <thead><tr><th>Date</th><th>User</th><th>Amount</th><th>Method</th><th>Account</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVNsMeB1jzOcIqAJjryUYmipT_SKrJi9k",
            authDomain: "giveawaybd.firebaseapp.com",
            databaseURL: "https://giveawaybd-default-rtdb.firebaseio.com",
            projectId: "giveawaybd",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- View Elements ---
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username-input');
        const passwordInput = document.getElementById('password-input');
        
        // Global state
        let currentSettings = {};
        let allUsersData = {};

        // --- Login Logic ---
        loginBtn.addEventListener('click', () => {
            const userVal = usernameInput.value;
            const passVal = passwordInput.value;
            db.ref('settings/adminAuth').once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const auth = snapshot.val();
                    if (userVal === auth.user && passVal === auth.pass) {
                        loginView.style.display = 'none';
                        adminView.style.display = 'block';
                        loadInitialData();
                    } else {
                        alert('Wrong username or password!');
                    }
                } else {
                    alert('Admin auth settings not found in Firebase.');
                }
            });
        });
        
        function loadInitialData() {
            loadSettings();
            loadWithdrawals();
            loadPurchases(); // নতুন ফাংশন কল
            loadUsers();
        }

        // --- Settings Logic ---
        const appNameInput = document.getElementById('app-name-input');
        const pointsPerAdInput = document.getElementById('points-per-ad-input');
        const dailyAdLimitInput = document.getElementById('daily-ad-limit-input');
        const minWithdrawInput = document.getElementById('min-withdraw-input');
        const maxWithdrawInput = document.getElementById('max-withdraw-input');
        const withdrawEnabledSelect = document.getElementById('withdraw-enabled-select');
        const methodsContainer = document.getElementById('withdrawal-methods-container');
        const addMethodBtn = document.getElementById('add-method-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const dailyBonusContainer = document.getElementById('daily-bonus-container');

        function loadSettings() {
             db.ref('settings').on('value', (snapshot) => {
                if (!snapshot.exists()) return;
                currentSettings = snapshot.val();
                appNameInput.value = currentSettings.appName || '';
                pointsPerAdInput.value = currentSettings.pointsPerAd || 10;
                dailyAdLimitInput.value = currentSettings.dailyAdLimit || 20;
                minWithdrawInput.value = currentSettings.minWithdraw || 0;
                maxWithdrawInput.value = currentSettings.maxWithdraw || 50000;
                withdrawEnabledSelect.value = currentSettings.isWithdrawEnabled !== undefined ? currentSettings.isWithdrawEnabled.toString() : 'true';
                
                renderWithdrawalMethods(currentSettings.withdrawalMethods);

                // === নতুন ডেইলি বোনাস সেটিংস লোড করা ===
                dailyBonusContainer.innerHTML = '';
                const dailyBonusPoints = currentSettings.dailyBonusPoints || [1, 2, 4, 10, 15, 17, 20]; // ডিফল্ট মান
                for (let i = 0; i < 7; i++) {
                    dailyBonusContainer.innerHTML += `
                        <div class="setting-item">
                            <label for="day-${i+1}-points">Day ${i+1} Points</label>
                            <input type="number" id="day-${i+1}-points" value="${dailyBonusPoints[i] || 0}">
                        </div>
                    `;
                }
            });
        }
        
        function renderWithdrawalMethods(methods) {
            methodsContainer.innerHTML = '';
            if (!methods) return;
            for (const key in methods) {
                const method = methods[key];
                addMethodUI(key, method.name, method.enabled);
            }
        }

        function addMethodUI(key, name = '', enabled = true) {
             const methodHtml = `
                <div class="method-item" data-key="${key}">
                    <input type="text" class="method-name" value="${name}" placeholder="Method Name (e.g., Bkash)">
                    <select class="method-enabled">
                        <option value="true" ${enabled ? 'selected' : ''}>Enabled</option>
                        <option value="false" ${!enabled ? 'selected' : ''}>Disabled</option>
                    </select>
                    <button class="btn btn-delete" onclick="this.parentElement.remove()">Delete</button>
                </div>
            `;
            methodsContainer.insertAdjacentHTML('beforeend', methodHtml);
        }
        
        addMethodBtn.addEventListener('click', () => {
            const newKey = `method_${Date.now()}`;
            addMethodUI(newKey);
        });

        saveSettingsBtn.addEventListener('click', () => {
            const updates = {
                appName: appNameInput.value,
                pointsPerAd: parseInt(pointsPerAdInput.value, 10) || 10,
                dailyAdLimit: parseInt(dailyAdLimitInput.value, 10) || 20,
                minWithdraw: parseInt(minWithdrawInput.value, 10) || 0,
                maxWithdraw: parseInt(maxWithdrawInput.value, 10) || 50000,
                isWithdrawEnabled: withdrawEnabledSelect.value === 'true',
            };
            
            const newWithdrawalMethods = {};
            document.querySelectorAll('.method-item').forEach(item => {
                const key = item.dataset.key;
                const name = item.querySelector('.method-name').value.trim();
                const enabled = item.querySelector('.method-enabled').value === 'true';
                if(name) {
                    newWithdrawalMethods[key] = { name, enabled };
                }
            });
            updates.withdrawalMethods = newWithdrawalMethods;

            // === নতুন ডেইলি বোনাস সেটিংস সেভ করা ===
            const newDailyBonusPoints = [];
            for (let i = 0; i < 7; i++) {
                const points = parseInt(document.getElementById(`day-${i+1}-points`).value, 10) || 0;
                newDailyBonusPoints.push(points);
            }
            updates.dailyBonusPoints = newDailyBonusPoints;

            db.ref('settings').update(updates)
                .then(() => alert('Settings saved successfully!'))
                .catch(err => alert('Error saving settings: ' + err.message));
        });

        // --- Notice Logic (কোনো পরিবর্তন নেই) ---
        const noticeInput = document.getElementById('notice-input');
        const sendNoticeBtn = document.getElementById('send-notice-btn');
        const removeNoticeBtn = document.getElementById('remove-notice-btn');
        sendNoticeBtn.addEventListener('click', () => { const noticeText = noticeInput.value.trim(); if (!noticeText) { alert("Please enter a notice."); return; } if (confirm("Are you sure?")) { db.ref('users').once('value', snapshot => { const updates = {}; snapshot.forEach(child => { updates[`${child.key}/notice`] = noticeText; }); db.ref('users').update(updates).then(() => alert("Notice sent successfully!")); }); } });
        removeNoticeBtn.addEventListener('click', () => { if (confirm("Are you sure?")) { db.ref('users').once('value', snapshot => { const updates = {}; snapshot.forEach(child => { updates[`${child.key}/notice`] = null; }); db.ref('users').update(updates).then(() => { noticeInput.value = ''; alert("Notice removed successfully!"); }); }); } });
        
        // --- === নতুন Shop Orders ফাংশন === ---
        function loadPurchases() {
            db.ref('purchases').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                const tableBody = document.querySelector("#purchases-table tbody");
                tableBody.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const key = child.key;
                        const data = child.val();
                        const date = new Date(data.purchasedAt).toLocaleString();
                        tableBody.innerHTML += `
                            <tr>
                                <td>${date}</td>
                                <td>${data.userName} (${data.userId})</td>
                                <td>${data.quantity} ${data.itemType}</td>
                                <td><a href="${data.link}" target="_blank" rel="noopener noreferrer">View Link</a></td>
                                <td>${data.cost}</td>
                                <td class="actions-cell">
                                    <button class="btn btn-approve" onclick="handleShopOrder('${key}', 'approved')">Approve</button>
                                    <button class="btn btn-reject" onclick="handleShopOrder('${key}', 'rejected')">Reject</button>
                                </td>
                            </tr>`;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending orders.</td></tr>';
                }
            });
        }
        window.handleShopOrder = (key, action) => {
            const ref = db.ref(`purchases/${key}`);
            if (action === 'approved') {
                ref.update({ status: 'approved' }).then(() => alert('Order approved.'));
            } else if (action === 'rejected') {
                 ref.once('value').then(snapshot => {
                    const data = snapshot.val();
                    db.ref(`users/${data.userId}/points`).transaction(points => (points || 0) + data.cost);
                    ref.update({ status: 'rejected' }).then(() => alert('Order rejected, points returned to user.'));
                });
            }
        };

        // --- Withdrawals Logic (কোনো পরিবর্তন নেই) ---
        function loadWithdrawals() {
            db.ref('withdrawals').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                const tableBody = document.querySelector("#withdrawals-table tbody");
                tableBody.innerHTML = '';
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const key = child.key;
                        const data = child.val();
                        const date = new Date(data.requestedAt).toLocaleString();
                        tableBody.innerHTML += `<tr><td>${date}</td><td>${data.userName} (${data.userId})</td><td>${data.amount}</td><td>${data.method}</td><td>${data.account}</td><td class="actions-cell"><button class="btn btn-approve" onclick="handleWithdrawal('${key}', 'approved')">Approve</button><button class="btn btn-reject" onclick="handleWithdrawal('${key}', 'rejected')">Reject</button></td></tr>`;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No pending withdrawals.</td></tr>';
                }
            });
        }
        window.handleWithdrawal = (key, action) => {
            const ref = db.ref(`withdrawals/${key}`);
            if (action === 'approved') {
                ref.update({ status: 'approved' }).then(() => alert('Withdrawal approved.'));
            } else if (action === 'rejected') {
                 ref.once('value').then(snapshot => {
                    const data = snapshot.val();
                    db.ref(`users/${data.userId}/points`).transaction(points => (points || 0) + data.amount);
                    ref.update({ status: 'rejected' }).then(() => alert('Withdrawal rejected, points returned.'));
                });
            }
        };

        // --- Users Logic (কোনো পরিবর্তন নেই) ---
        const searchUserInput = document.getElementById('search-user-input');
        function loadUsers() {
            db.ref('users').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    allUsersData = snapshot.val();
                    renderUsers(allUsersData);
                }
            });
        }
        function renderUsers(users) {
            const tableBody = document.querySelector("#users-table tbody");
            tableBody.innerHTML = '';
            for(const userId in users) {
                const data = users[userId];
                tableBody.innerHTML += `<tr><td>${userId}</td><td>${data.name || 'N/A'}</td><td>${data.points || 0}</td><td class="actions-cell"><button class="btn btn-edit" onclick="editPoints('${userId}', '${data.name || ''}')">Edit Points</button></td></tr>`;
            }
        }
        searchUserInput.addEventListener('keyup', () => { const searchTerm = searchUserInput.value.toLowerCase(); if(!searchTerm) { renderUsers(allUsersData); return; } const filteredUsers = {}; for(const userId in allUsersData) { const name = (allUsersData[userId].name || '').toLowerCase(); if(userId.includes(searchTerm) || name.includes(searchTerm)) { filteredUsers[userId] = allUsersData[userId]; } } renderUsers(filteredUsers); });
        window.editPoints = (userId, name) => { const currentPoints = allUsersData[userId].points || 0; const newPoints = prompt(`Enter new point amount for ${name} (${userId}):`, currentPoints); if (newPoints !== null && !isNaN(newPoints)) { db.ref(`users/${userId}/points`).set(parseInt(newPoints, 10)).then(() => alert('Points updated!')); } };
    </script>
</body>
                </html>
