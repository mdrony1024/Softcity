<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Softcity</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary-color: #5856d6; --light-bg: #f0f2f5; --white: #fff; --dark-text: #1c1e21; --light-text: #666; --border-color: #ddd; --danger-color: #fa3e3e; --success-color: #42b72a; --warning-color: #f5a623; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--light-bg); color: var(--dark-text); display: flex; }
        .sidebar { width: 240px; background: var(--white); height: 100vh; position: fixed; box-shadow: 2px 0 5px rgba(0,0,0,0.05); transition: width 0.3s ease; z-index: 100; overflow-x: hidden; }
        .sidebar.collapsed { width: 80px; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .sidebar-header h2 { margin: 0; font-size: 24px; color: var(--primary-color); white-space: nowrap; }
        .sidebar.collapsed .sidebar-header h2 { display: none; }
        .sidebar-nav ul { list-style: none; padding: 10px 0; margin: 0; }
        .sidebar-nav ul li a { display: flex; align-items: center; padding: 15px 20px; color: #333; text-decoration: none; font-weight: 500; white-space: nowrap; border-left: 3px solid transparent; }
        .sidebar-nav ul li a .icon { font-size: 22px; width: 40px; text-align: center; }
        .sidebar-nav ul li a .title { transition: opacity 0.2s; }
        .sidebar.collapsed .sidebar-nav ul li a .title { opacity: 0; display: none; }
        .sidebar-nav ul li a.active, .sidebar-nav ul li a:hover { background: var(--light-bg); color: var(--primary-color); border-left-color: var(--primary-color); }
        #sidebar-toggle { position: fixed; left: 220px; top: 15px; background: var(--white); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; z-index: 101; transition: left 0.3s ease; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .sidebar.collapsed #sidebar-toggle { left: 60px; }
        .main-content { margin-left: 240px; padding: 20px; width: calc(100% - 240px); transition: margin-left 0.3s ease, width 0.3s ease; }
        .sidebar.collapsed ~ .main-content { margin-left: 80px; width: calc(100% - 80px); }
        .container { max-width: 1200px; margin: auto; }
        #login-view { display: flex; width: 100%; height: 100vh; align-items: center; justify-content: center; }
        #admin-view { display: none; width: 100%; }
        .admin-page { display: none; animation: fadeIn 0.5s; }
        .admin-page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--white); padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        h1, h2, h3, h4 { color: var(--dark-text); padding-bottom: 10px; margin-top: 0; }
        h2, h3 { border-bottom: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; vertical-align: middle; word-break: break-word; }
        th { background-color: #f5f6f7; font-weight: 600; }
        .btn { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
        .btn:hover { opacity: 0.85; }
        .btn-approve { background-color: var(--success-color); color: white; } 
        .btn-reject { background-color: var(--danger-color); color: white; }
        .btn-edit { background-color: var(--primary-color); color: white; } 
        .btn-save { background-color: var(--warning-color); color: white; }
        .btn-add { background-color: #007bff; color: white; }
        input, select, textarea { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; margin-top: 5px; }
        .form-group { margin-bottom: 15px; }
        .setting-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding-top: 15px; }
        .dynamic-item-container { border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-top: 15px; position: relative; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold; }
        /* NEW CSS for filter buttons */
        .filter-tabs { margin-bottom: 15px; }
        .filter-btn { background-color: #e4e6eb; color: #333; margin-right: 10px; }
        .filter-btn.active { background-color: var(--primary-color); color: white; }
    </style>
</head>
<body>

    <div id="login-view">
        <div class="card" style="width: 360px;">
            <h1>Admin Login</h1>
            <div class="form-group"><label for="username-input">Username</label><input type="text" id="username-input"></div>
            <div class="form-group"><label for="password-input">Password</label><input type="password" id="password-input"></div>
            <button id="login-btn" class="btn btn-edit" style="width: 100%;">Login</button>
        </div>
    </div>

    <div id="admin-view">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header"><h2>Softcity</h2></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#settings" class="nav-link active"><span class="icon">‚öôÔ∏è</span><span class="title">App Settings</span></a></li>
                    <li><a href="#shop-orders" class="nav-link"><span class="icon">üõí</span><span class="title">Shop Orders</span></a></li>
                    <li><a href="#withdrawals" class="nav-link"><span class="icon">üí∏</span><span class="title">Withdrawals</span></a></li>
                    <li><a href="#users" class="nav-link"><span class="icon">üë•</span><span class="title">Users</span></a></li>
                    <li><a href="#notice" class="nav-link"><span class="icon">üì¢</span><span class="title">Notice</span></a></li>
                </ul>
            </nav>
        </aside>
        
        <button id="sidebar-toggle">‚ò∞</button>

        <main class="main-content">
            <div class="container">
                <div id="settings" class="admin-page active"><!-- Settings content --></div>

                <div id="shop-orders" class="admin-page">
                    <div class="card">
                        <h2 id="purchases-title">Pending Shop Orders</h2>
                        <!-- NEW: Filter buttons for Shop Orders -->
                        <div class="filter-tabs" id="purchases-filters">
                            <button class="btn filter-btn active" onclick="loadPurchases('pending')">Pending</button>
                            <button class="btn filter-btn" onclick="loadPurchases('all')">All Recent</button>
                        </div>
                        <table id="purchases-table">
                            <thead>
                                <tr><th>Date</th><th>User</th><th>Item</th><th>Link</th><th>Cost</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="withdrawals" class="admin-page">
                    <div class="card">
                        <h2 id="withdrawals-title">Pending Withdrawals</h2>
                        <!-- NEW: Filter buttons for Withdrawals -->
                        <div class="filter-tabs" id="withdrawals-filters">
                            <button class="btn filter-btn active" onclick="loadWithdrawals('pending')">Pending</button>
                            <button class="btn filter-btn" onclick="loadWithdrawals('all')">All Recent</button>
                        </div>
                        <table id="withdrawals-table">
                            <thead>
                                <tr><th>Date</th><th>User</th><th>Amount</th><th>Method</th><th>Account</th><th>Status</th><th>Actions</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                 <div id="users" class="admin-page"><!-- Users content --></div>
                 <div id="notice" class="admin-page"><!-- Notice content --></div>
            </div>
        </main>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDVNsMeB1jzOcIqAJjryUYmipT_SKrJi9k", authDomain: "giveawaybd.firebaseapp.com", databaseURL: "https://giveawaybd-default-rtdb.firebaseio.com", projectId: "giveawaybd" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let allUsersData = {};
    let currentPurchaseFilter = 'pending'; // To remember current filter state
    let currentWithdrawalFilter = 'pending';

    // --- Authentication (Same as your code) ---
    document.getElementById('login-btn').addEventListener('click', () => {
        const user = document.getElementById('username-input').value;
        const pass = document.getElementById('password-input').value;
        db.ref('settings/adminAuth').once('value', s => {
            if (s.exists() && user === s.val().user && pass === s.val().pass) {
                document.getElementById('login-view').style.display = 'none';
                document.getElementById('admin-view').style.display = 'flex';
                loadInitialData();
            } else { alert('Wrong credentials!'); }
        });
    });

    function loadInitialData() {
        loadSettings(); 
        loadWithdrawals('pending'); // Load pending withdrawals by default
        loadPurchases('pending'); // Load pending orders by default
        loadUsers();
        // Setup UI listeners
        const sidebar = document.getElementById('sidebar');
        document.getElementById('sidebar-toggle').addEventListener('click', () => sidebar.classList.toggle('collapsed'));
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
                link.classList.add('active');
                document.getElementById(targetId).classList.add('active');
            });
        });
    }

    // --- Settings, Users, Notice (Same as your code) ---
    // These sections are unchanged. I'm omitting them for brevity.
    // Please ensure you have your original functions for settings, users, and notice here.
    
    // --- Order & Withdrawal Handling (MODIFIED) ---
    const createRow = (d, type) => {
        const date = new Date(type === 'purchase' ? d.createdAt : d.requestedAt).toLocaleString();
        const status = d.status || 'pending';
        let statusStyle = '';
        if (status === 'completed') statusStyle = 'color: var(--success-color); font-weight: bold; text-transform: capitalize;';
        else if (status === 'rejected') statusStyle = 'color: var(--danger-color); font-weight: bold; text-transform: capitalize;';
        else statusStyle = 'color: var(--warning-color); font-weight: bold; text-transform: capitalize;';
        const actions = status === 'pending'
            ? `<button class="btn btn-approve" onclick="handleRequest('${type}','${d.key}','approved')">Approve</button>
               <button class="btn btn-reject" onclick="handleRequest('${type}','${d.key}','rejected')" style="margin-left:5px;">Reject</button>`
            : `<span>Processed</span>`;
        const info = type === 'purchase'
            ? `<td>${d.quantity} ${d.itemType}</td><td><a href="${d.link}" target="_blank">View Link</a></td><td>${d.cost}</td>`
            : `<td>${d.amount}</td><td>${d.method}</td><td>${d.account}</td>`;
        return `<td>${date}</td><td>${d.userName} (${d.userId})</td>${info}<td style="${statusStyle}">${status}</td><td>${actions}</td>`;
    };
    
    // **MODIFIED:** This function now accepts a filter ('pending' or 'all')
    function loadPurchases(filter) {
        currentPurchaseFilter = filter; // Remember the filter
        document.querySelector('#purchases-title').textContent = filter === 'pending' ? 'Pending Shop Orders' : 'All Recent Shop Orders';
        
        // Update active button style
        document.querySelectorAll('#purchases-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        let query = db.ref('purchases');
        if (filter === 'pending') {
            query = query.orderByChild('status').equalTo('pending');
        } else {
            query = query.orderByKey().limitToLast(50);
        }

        query.once('value', s => { 
            const tbody = document.querySelector("#purchases-table tbody"); 
            tbody.innerHTML = ''; 
            if (s.exists()) {
                const requests = [];
                s.forEach(c => requests.push({key: c.key, ...c.val()}));
                requests.reverse().forEach(d => {
                    const row = tbody.insertRow();
                    row.innerHTML = createRow(d, 'purchase');
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="7" align="center">No ${filter} orders found.</td></tr>`; 
            }
        }); 
    }

    // **MODIFIED:** This function also accepts a filter
    function loadWithdrawals(filter) {
        currentWithdrawalFilter = filter; // Remember the filter
        document.querySelector('#withdrawals-title').textContent = filter === 'pending' ? 'Pending Withdrawals' : 'All Recent Withdrawals';

        // Update active button style
        document.querySelectorAll('#withdrawals-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        let query = db.ref('withdrawals');
        if (filter === 'pending') {
            query = query.orderByChild('status').equalTo('pending');
        } else {
            query = query.orderByKey().limitToLast(50);
        }

        query.once('value', s => { 
            const tbody = document.querySelector("#withdrawals-table tbody"); 
            tbody.innerHTML = ''; 
            if (s.exists()) {
                const requests = [];
                s.forEach(c => requests.push({key: c.key, ...c.val()}));
                requests.reverse().forEach(d => {
                    const row = tbody.insertRow();
                    row.innerHTML = createRow(d, 'withdrawal');
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="7" align="center">No ${filter} withdrawals found.</td></tr>`; 
            }
        }); 
    }
    
    // **MODIFIED:** After handling a request, it reloads the list with the current filter
    window.handleRequest = (type, key, status) => {
        const ref = db.ref(`${type}s/${key}`);
        if (status === 'approved') {
            ref.update({ status: 'completed' }).then(() => {
                alert(`${type} approved.`);
                if (type === 'withdrawal') loadWithdrawals(currentWithdrawalFilter); else loadPurchases(currentPurchaseFilter);
            });
        } else { // rejected
            ref.once('value').then(s => {
                if (!s.exists()) return;
                const data = s.val();
                if (data.status !== 'pending') { alert('This request has already been processed.'); return; }
                const pointsToReturn = data.cost || data.amount;
                db.ref(`users/${data.userId}/points`).transaction(p => (p || 0) + pointsToReturn);
                ref.update({ status: 'rejected' }).then(() => {
                    alert(`${type} rejected, points returned.`);
                    if (type === 'withdrawal') loadWithdrawals(currentWithdrawalFilter); else loadPurchases(currentPurchaseFilter);
                });
            });
        }
    };
    
</script>
</body>
</html>
